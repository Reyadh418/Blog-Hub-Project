<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Blog Post</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Trebuchet MS, sans-serif;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                min-height: 100vh;
                padding: 40px 20px;
            }

            .post-header {
                max-width: 900px;
                margin: 0 auto 30px;
                text-align: center;
            }

            .nav-back {
                display: inline-block;
                margin-bottom: 20px;
                color: #d4a574;
                text-decoration: none;
                font-weight: 600;
                font-size: 0.95rem;
                transition: color 0.3s ease;
                letter-spacing: 0.5px;
            }

            .nav-back:hover {
                color: #e8b896;
            }

            h1 {
                color: #1e3a5f;
                font-size: 2.8rem;
                font-weight: 300;
                letter-spacing: 1px;
                margin-bottom: 20px;
                line-height: 1.2;
            }

            .post-header h1 {
                color: #1e3a5f;
            }

            .post-meta {
                color: #d4a574;
                font-size: 0.95rem;
                letter-spacing: 0.5px;
                display: flex;
                justify-content: center;
                gap: 20px;
                flex-wrap: wrap;
            }

            .meta-item {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .avatar-chip {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: #fff;
                box-shadow: 0 4px 10px rgba(0,0,0,0.12);
                text-transform: uppercase;
                flex-shrink: 0;
            }

            .loading {
                text-align: center;
                color: #ffffff;
                padding: 60px 20px;
                font-size: 1.1rem;
            }

            .spinner {
                display: inline-block;
                width: 50px;
                height: 50px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top-color: #ffffff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .post-container {
                max-width: 900px;
                margin: 0 auto;
                background: #ffffff;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                padding: 60px 50px;
                opacity: 0;
                animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .post-divider {
                height: 3px;
                background: linear-gradient(to right, #d4a574 0%, transparent 100%);
                margin: 40px 0;
            }

            .post-body {
                color: #2c3e50;
                font-size: 1.1rem;
                line-height: 1.9;
                margin-bottom: 40px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: pre-wrap;
            }

            .post-footer {
                padding-top: 30px;
                border-top: 2px solid #ecf0f1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 20px;
            }

            /* Animation styles */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes buttonPulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }

            .comment-item {
                animation: fadeIn 0.3s ease-out;
            }

            .reaction-btn {
                transition: all 0.2s ease;
            }

            .reaction-btn:active {
                animation: buttonPulse 0.3s ease;
            }

            .reaction-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .reaction-btn.is-active-useful {
                box-shadow: 0 6px 14px rgba(39, 174, 96, 0.25);
                transform: translateY(-1px);
                border-color: #27ae60 !important;
            }

            .reaction-btn.is-active-notuseful {
                box-shadow: 0 6px 14px rgba(231, 76, 60, 0.25);
                transform: translateY(-1px);
                border-color: #e74c3c !important;
            }

            .comment-form-container {
                animation: scaleIn 0.3s ease-out;
            }

            /* Comment cards & inline edit */
            .comment-card {
                padding: 20px;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                border-radius: 10px;
                border-left: 4px solid #d4a574;
                animation: fadeIn 0.3s ease-out;
            }

            .comment-meta {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
                gap: 12px;
            }

            .comment-actions {
                display: flex;
                gap: 8px;
                flex-shrink: 0;
            }

            .comment-action-btn {
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 600;
                transition: all 0.2s ease;
                color: #fff;
            }

            .comment-action-btn.edit {
                background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            }

            .comment-action-btn.delete {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            }

            .comment-action-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            }

            .comment-body {
                color: #2c3e50;
                margin: 12px 0;
                line-height: 1.7;
                word-wrap: break-word;
            }

            .comment-edit {
                display: none;
                animation: scaleIn 0.25s ease-out;
            }

            .comment-edit.show {
                display: block;
            }

            .comment-edit textarea {
                width: 100%;
                min-height: 110px;
                padding: 12px;
                border-radius: 8px;
                border: 2px solid #ecf0f1;
                font-family: inherit;
                font-size: 0.95rem;
                transition: all 0.2s ease;
                color: #2c3e50;
            }

            .comment-edit textarea:focus {
                border-color: #d4a574;
                box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.15);
                outline: none;
            }

            .comment-edit-actions {
                margin-top: 12px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .comment-edit-actions .save-btn {
                background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
                color: #fff;
                border: none;
                padding: 10px 18px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.2s ease;
            }

            .comment-edit-actions .cancel-btn {
                background: #ecf0f1;
                color: #2c3e50;
                border: none;
                padding: 10px 18px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s ease;
            }

            .comment-edit-actions button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            .count-bump {
                animation: bump 0.35s ease;
            }

            @keyframes bump {
                0% { transform: translateY(0); }
                40% { transform: translateY(-4px); }
                100% { transform: translateY(0); }
            }

            .post-stats {
                display: flex;
                gap: 30px;
                font-size: 0.95rem;
                color: #7f8c8d;
            }

            .stat-item {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .stat-label {
                color: #95a5a6;
                font-size: 0.85rem;
                font-weight: 500;
                letter-spacing: 0.4px;
                text-transform: uppercase;
            }

            .stat-value {
                color: #d4a574;
                font-weight: 600;
                font-size: 1rem;
            }

            .post-actions {
                display: flex;
                gap: 12px;
            }

            button {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.95rem;
                font-weight: 600;
                letter-spacing: 0.5px;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            .btn-home {
                background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%);
                color: #ffffff;
            }

            .btn-home:hover {
                background: linear-gradient(135deg, #e8b896 0%, #d4a574 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(212, 165, 116, 0.3);
            }

            .btn-copy {
                background: #ecf0f1;
                color: #2c3e50;
                border: 1px solid #bdc3c7;
            }

            .btn-copy:hover {
                background: #d4a574;
                color: #ffffff;
                border-color: #d4a574;
            }

            .btn-copy.copied {
                background: #27ae60;
                color: #ffffff;
                border-color: #27ae60;
            }

            .error-container {
                max-width: 900px;
                margin: 0 auto;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                padding: 40px;
                border-radius: 12px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            .error-icon {
                font-size: 3rem;
                margin-bottom: 16px;
            }

            .error-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 10px;
                letter-spacing: 0.5px;
            }

            .error-text {
                font-size: 1rem;
                margin-bottom: 25px;
                opacity: 0.95;
            }

            .error-back {
                display: inline-block;
                background: rgba(255, 255, 255, 0.2);
                color: #ffffff;
                padding: 12px 24px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .error-back:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 1.8rem;
                }

                .post-container {
                    padding: 30px 20px;
                }

                .post-body {
                    font-size: 1rem;
                    line-height: 1.8;
                }

                .post-footer {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .post-stats {
                    flex-wrap: wrap;
                    gap: 20px;
                }

                .post-actions {
                    width: 100%;
                }

                button {
                    flex: 1;
                    min-width: 120px;
                }
            }
        </style>
    </head>
    <body>
        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading post...</p>
        </div>

        <div id="post-wrapper" style="display: none;">
            <div class="post-header">
                <a href="/" class="nav-back">‚Üê Back to Blog</a>
                <form id="post-search-form" style="display:inline-block; margin-left:12px;">
                    <input id="post-search-input" type="search" placeholder="Search blog..." style="padding:8px 10px;border-radius:8px;border:1px solid #dfe6ea;" />
                    <button id="post-search-btn" type="submit" style="padding:8px 10px;border-radius:8px;border:none;margin-left:6px;background:#d4a574;color:#fff;">üîé</button>
                </form>
            </div>

            <div class="post-container">
                <div class="post-header">
                    <h1 id="postTitle"></h1>                    <div id="flagNotice" style="display:none; background:#fee; color:#c33; padding:16px; border-radius:6px; margin-bottom:20px; font-weight:600; text-align:center;">
                        üö© This post has been flagged by an administrator
                    </div>                    <div class="post-meta">
                        <div class="meta-item">
                            üìÖ <span id="postDate"></span>
                        </div>
                        <div class="meta-item">
                            ÔøΩ <span id="authorName">Unknown</span>
                        </div>
                        <div class="meta-item">
                            ÔøΩüìù <span id="wordCount">0</span> words
                        </div>
                        <div class="meta-item">
                            ‚è±Ô∏è <span id="readTime">0</span> min read
                        </div>
                    </div>
                </div>

                <div class="post-divider"></div>

                <p class="post-body" id="postBody"></p>

                <div class="post-footer">
                    <div class="post-stats">
                        <div class="stat-item">
                            <span class="stat-label">Word Count</span>
                            <span class="stat-value" id="statWordCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Published</span>
                            <span class="stat-value" id="statDate"></span>
                        </div>
                    </div>
                    <div class="post-actions">
                        <button class="btn-copy" onclick="copyPostLink()" id="copyBtn">üìã Copy Link</button>
                        <button id="flagBtn" class="btn-home" style="display:none;">üö© Flag</button>
                        <button id="editPostBtn" class="btn-home" style="display:none;">‚úé Edit</button>
                        <button id="deletePostBtn" class="btn-home" style="display:none;">üóë Delete</button>
                        <button class="btn-home" onclick="location.href='/'">üè† Back Home</button>
                    </div>
                </div>

                <!-- Reactions Section -->
                <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: fadeIn 0.5s ease-out;">
                    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: #1e3a5f; font-size: 1.1rem; letter-spacing: 0.3px;">Was this helpful?</span>
                        <button id="usefulBtn" class="reaction-btn" style="display:none; background: linear-gradient(135deg, #f0f9f0 0%, #ffffff 100%); border: 2px solid #27ae60; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #27ae60; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, #d4f1d4 0%, #f0f9f0 100%)'; this.style.boxShadow='0 4px 12px rgba(39, 174, 96, 0.2)';" onmouseout="this.style.background='linear-gradient(135deg, #f0f9f0 0%, #ffffff 100%)'; this.style.boxShadow='none';">üëç <span id="usefulCount">0</span></button>
                        <button id="notusefulBtn" class="reaction-btn" style="display:none; background: linear-gradient(135deg, #fff0f0 0%, #ffffff 100%); border: 2px solid #e74c3c; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #e74c3c; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, #fde4e4 0%, #fff0f0 100%)'; this.style.boxShadow='0 4px 12px rgba(231, 76, 60, 0.2)';" onmouseout="this.style.background='linear-gradient(135deg, #fff0f0 0%, #ffffff 100%)'; this.style.boxShadow='none';">üëé <span id="notusefulCount">0</span></button>
                        <span id="reactLoginPrompt" style="color: #7f8c8d; font-size: 0.95rem; padding: 10px 16px; background: #ecf0f1; border-radius: 8px;">üìù <a href="/login.html" style="color: #4a90e2; text-decoration: none; font-weight: 600;">Log in to react</a></span>
                    </div>
                </div>

                <!-- Comments Section -->
                <div style="margin-top: 50px; animation: fadeIn 0.6s ease-out;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                        <h2 style="font-size: 1.5rem; color: #1e3a5f; margin: 0; font-weight: 600; letter-spacing: 0.3px;">üí¨ Comments <span style="background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%); color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 0.9rem; margin-left: 10px;">(<span id="commentCount">0</span>)</span></h2>
                    </div>

                    <!-- Comment Form (only for logged in users) -->
                    <div id="commentForm" style="display: none; margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #d4a574; animation: scaleIn 0.3s ease-out;" class="comment-form-container">
                        <form onsubmit="submitComment(event)">
                            <label style="display: block; margin-bottom: 10px; color: #1e3a5f; font-weight: 600;">Share your thoughts</label>
                            <textarea id="commentBody" placeholder="What do you think about this post?" style="width: 100%; padding: 14px; border: 2px solid #ecf0f1; border-radius: 8px; font-family: inherit; font-size: 0.95rem; min-height: 110px; resize: vertical; transition: all 0.3s ease; color: #2c3e50;" onfocus="this.style.borderColor='#d4a574'; this.style.boxShadow='0 0 0 3px rgba(212, 165, 116, 0.1)';" onblur="this.style.borderColor='#ecf0f1'; this.style.boxShadow='none';"></textarea>
                            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button type="submit" id="submitCommentBtn" style="background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%); color: #fff; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(212, 165, 116, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(212, 165, 116, 0.2)';">‚úì Post Comment</button>
                                <button type="button" onclick="document.getElementById('commentForm').style.display='none'; document.getElementById('commentBody').value='';" style="background: #ecf0f1; color: #2c3e50; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.background='#ddd';" onmouseout="this.style.background='#ecf0f1';">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Comment prompt for non-logged-in users -->
                    <div id="commentLoginPrompt" style="display: none; margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fc 100%); border-radius: 12px; text-align: center; color: #1e3a5f; border-left: 4px solid #4a90e2; animation: slideUp 0.3s ease-out;">
                        <p style="margin: 0 0 15px 0; font-weight: 600; font-size: 1.05rem;">üìù Log in to join the conversation</p>
                        <button onclick="window.location.href='/login.html'" style="margin-top: 0; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: #fff; padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(74, 144, 226, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(74, 144, 226, 0.2)';">Log In or Sign Up</button>
                    </div>

                    <!-- Comments List -->
                    <div id="commentsList" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Comments will be inserted here -->
                    </div>

                    <!-- No comments message -->
                    <div id="noComments" style="text-align: center; padding: 50px 30px; color: #95a5a6; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; animation: fadeIn 0.4s ease-out;">
                        <span style="font-size: 2rem;">üí≠</span>
                        <p style="margin-top: 10px; font-size: 1rem;">No comments yet. Be the first to share your thoughts!</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="error-wrapper" style="display: none;">
            <div class="error-container">
                <div class="error-icon">‚ö†Ô∏è</div>
                <div class="error-title">Post Not Found</div>
                <p class="error-text" id="errorMessage">The post you're looking for doesn't exist.</p>
                <a href="/" class="error-back">‚Üê Back to Blog</a>
            </div>
        </div>

        <script>
            const LOADING = document.getElementById('loading');
            const POST_WRAPPER = document.getElementById('post-wrapper');
            const ERROR_WRAPPER = document.getElementById('error-wrapper');
            const ERROR_MESSAGE = document.getElementById('errorMessage');

            const AVATAR_PALETTE = {
                aurora: 'linear-gradient(135deg, #5efce8 0%, #736efe 100%)',
                sunset: 'linear-gradient(135deg, #f83600 0%, #f9d423 100%)',
                wave: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)',
                forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                midnight: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)',
                plum: 'linear-gradient(135deg, #cc2b5e 0%, #753a88 100%)',
                citrus: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
                ember: 'linear-gradient(135deg, #e65c00 0%, #f9d423 100%)',
                mint: 'linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%)',
            };

            function avatarStyle(key) {
                return AVATAR_PALETTE[key] || 'linear-gradient(135deg, #d4a574 0%, #b8956a 100%)';
            }

            // Get post ID from URL query parameter
            function getPostId() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            }

            // Count words in text
            function countWords(text) {
                return text.trim().split(/\s+/).length;
            }

            // Estimate reading time (200 words per minute)
            function estimateReadTime(wordCount) {
                return Math.max(1, Math.ceil(wordCount / 200));
            }

            // Format date nicely
            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            // Fetch post by ID
            async function fetchPost(postId) {
                try {
                    const response = await fetch(`/api/posts/${postId}`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            showError('The post you\'re looking for doesn\'t exist.');
                        } else {
                            showError('Failed to fetch the post.');
                        }
                        return null;
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error fetching post:', error);
                    showError('Unable to load the post. Please try again later.');
                    return null;
                }
            }

            // Render post content
            function renderPost(post) {
                const wordCount = countWords(post.body);
                const readTime = estimateReadTime(wordCount);
                const formattedDate = formatDate(post.created_at);
                const authorDisplay = post.author_name || 'Unknown';
                const isAdminPost = post.is_admin_post === 1 || post.author_id === null;
                const authorInitial = authorDisplay.charAt(0).toUpperCase();
                const authorAvatarBg = avatarStyle(post.author_avatar || '');

                // Update title
                document.title = `${post.title} | Blog`;
                document.getElementById('postTitle').textContent = escapeHtml(post.title);

                // Show flag notice if post is flagged
                if (post.is_flagged) {
                    document.getElementById('flagNotice').style.display = 'block';
                }

                // Update meta information
                document.getElementById('postDate').textContent = formattedDate;
                document.getElementById('wordCount').textContent = wordCount;
                document.getElementById('readTime').textContent = readTime;
                document.getElementById('authorName').innerHTML = isAdminPost
                    ? `<span style="display:flex; align-items:center; gap:8px; color:#1e3a5f; font-weight:700;"><span class="avatar-chip" style="background:linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%)">üëë</span><span>Admin</span></span>`
                    : `<span class="avatar-chip" style="background:${authorAvatarBg}">${escapeHtml(authorInitial)}</span><span>${escapeHtml(authorDisplay)}</span>`;

                // Update body
                document.getElementById('postBody').textContent = post.body;

                // Update stats
                document.getElementById('statWordCount').textContent = wordCount;
                document.getElementById('statDate').textContent = formattedDate;

                LOADING.style.display = 'none';
                POST_WRAPPER.style.display = 'block';
                // show admin controls if applicable
                maybeShowAdminActions(post.id, post.author_id);
            }

            // Fetch current user (to show admin controls)
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/api/auth/me');
                    if (response.ok) {
                        const data = await response.json();
                        return { isAdmin: data.isAdmin === true, userId: data.id || data.userId || null };
                    }
                } catch (err) {
                    console.error('fetchCurrentUser failed', err);
                }
                return { isAdmin: false, userId: null };
            }

            // Toast system
            function showToast(message, type='info', duration=3000) {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<span class="toast-icon">${type==='success'?'‚úì':type==='error'?'‚úï':'‚Ñπ'}</span><div class="toast-message">${message}</div><span class="toast-close">&times;</span>`;
                container.appendChild(toast);
                toast.querySelector('.toast-close').addEventListener('click', () => toast.remove());
                if (duration>0) setTimeout(()=> { if (toast.parentElement) toast.remove(); }, duration);
            }

            // Show admin actions (edit/delete/flag)
            async function maybeShowAdminActions(postId, authorId) {
                const user = await fetchCurrentUser();

                // Check permissions
                let canEdit = false;
                let canDelete = false;
                let canFlag = false;

                if (user.isAdmin) {
                    canEdit = authorId === null; // Admin can only edit own posts
                    canDelete = true; // Admin can delete any
                    canFlag = true; // Admin can flag any
                } else if (user.userId) {
                    canEdit = authorId === user.userId; // User can only edit own
                    canDelete = authorId === user.userId; // User can only delete own
                }

                // Flag button (admin only)
                if (canFlag) {
                    const flagBtn = document.getElementById('flagBtn');
                    flagBtn.style.display = 'inline-block';
                    flagBtn.textContent = document.getElementById('flagNotice').style.display === 'block' ? '‚úì Unflag' : 'üö© Flag';
                    flagBtn.onclick = async (e) => {
                        e.preventDefault();
                        const isFlagged = document.getElementById('flagNotice').style.display === 'block';
                        try {
                            const resp = await fetch(`/api/posts/${postId}/flag`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ flag: !isFlagged })
                            });
                            if (resp.ok) {
                                if (!isFlagged) {
                                    document.getElementById('flagNotice').style.display = 'block';
                                    flagBtn.textContent = '‚úì Unflag';
                                    showToast('Post flagged', 'success', 1800);
                                } else {
                                    document.getElementById('flagNotice').style.display = 'none';
                                    flagBtn.textContent = 'üö© Flag';
                                    showToast('Post unflagged', 'success', 1200);
                                }
                            } else {
                                const err = await resp.json().catch(()=>({error:'Failed to flag/unflag'}));
                                showToast(err.error || 'Failed to flag/unflag post', 'error');
                            }
                        } catch (error) {
                            console.error('Flag error:', error);
                            showToast('Error flagging post', 'error');
                        }
                    };
                }

                // Edit button
                if (canEdit) {
                    const editBtn = document.getElementById('editPostBtn');
                    editBtn.style.display = 'inline-block';
                    editBtn.onclick = (e) => {
                        e.preventDefault();
                        window.location.href = `/create-post.html?id=${postId}&edit=1`;
                    };
                }

                // Delete button
                if (canDelete) {
                    const deleteBtn = document.getElementById('deletePostBtn');
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.onclick = async (e) => {
                        e.preventDefault();
                        if (!confirm('Delete this post? This action cannot be undone.')) return;
                        try {
                            const resp = await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
                                if (resp.ok) {
                                window.location.href = '/';
                            } else {
                                const err = await resp.json().catch(()=>({error:'Failed to delete post'}));
                                showToast(err.error || 'Failed to delete post', 'error');
                            }
                        } catch (error) {
                            console.error('Delete error:', error);
                            showToast('Error deleting post', 'error');
                        }
                    };
                }
            }


            // Show error message
            function showError(message) {
                ERROR_MESSAGE.textContent = message;
                LOADING.style.display = 'none';
                ERROR_WRAPPER.style.display = 'block';
            }

            // Copy post link to clipboard
            async function copyPostLink() {
                const postId = getPostId();
                const link = `${window.location.origin}/post.html?id=${postId}`;
                
                try {
                    await navigator.clipboard.writeText(link);
                    const btn = document.getElementById('copyBtn');
                    const originalText = btn.textContent;
                    
                    btn.textContent = '‚úì Copied!';
                    btn.classList.add('copied');

                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy link', 'error');
                }
            }

            // Initialize page
            async function initializePage() {
                const postId = getPostId();

                if (!postId) {
                    showError('No post ID provided. Please go back and select a post.');
                    return;
                }

                LOADING.style.display = 'block';
                const post = await fetchPost(postId);

                if (post) {
                    renderPost(post);
                }
            }

            // Load on page ready
            // Wire up inline search from post page
            const POST_SEARCH_FORM = document.getElementById('post-search-form');
            const POST_SEARCH_INPUT = document.getElementById('post-search-input');
            if (POST_SEARCH_FORM) {
                POST_SEARCH_FORM.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const q = (POST_SEARCH_INPUT.value || '').toString().trim();
                    if (!q) return;
                    window.location.href = `/?q=${encodeURIComponent(q)}`;
                });
            }

            // ===== REACTIONS CODE =====
            let currentUser = null;
            let currentUserReaction = null;

            async function loadReactions(postId) {
                try {
                    const response = await fetch(`/api/posts/${postId}/reactions`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('usefulCount').textContent = data.useful;
                        document.getElementById('notusefulCount').textContent = data.notUseful;
                        currentUserReaction = data.userReaction;
                        updateReactionButtonStyles(data.userReaction);
                    }
                } catch (err) {
                    console.error('Error loading reactions:', err);
                }
            }

            function updateReactionButtonStyles(userReaction) {
                const usefulBtn = document.getElementById('usefulBtn');
                const notusefulBtn = document.getElementById('notusefulBtn');
                
                usefulBtn.classList.toggle('is-active-useful', userReaction === 'useful');
                notusefulBtn.classList.toggle('is-active-notuseful', userReaction === 'notuseful');

                if (userReaction === 'useful') {
                    usefulBtn.style.borderColor = '#27ae60';
                    usefulBtn.style.background = '#d4f1d4';
                    notusefulBtn.style.borderColor = 'transparent';
                    notusefulBtn.style.background = '#ecf0f1';
                } else if (userReaction === 'notuseful') {
                    notusefulBtn.style.borderColor = '#e74c3c';
                    notusefulBtn.style.background = '#fde4e4';
                    usefulBtn.style.borderColor = 'transparent';
                    usefulBtn.style.background = '#ecf0f1';
                } else {
                    usefulBtn.style.borderColor = 'transparent';
                    usefulBtn.style.background = '#ecf0f1';
                    notusefulBtn.style.borderColor = 'transparent';
                    notusefulBtn.style.background = '#ecf0f1';
                }
            }

            async function submitReaction(reactionType) {
                if (!currentUser || (!currentUser.userId && !currentUser.isAdmin)) {
                    window.location.href = '/login.html';
                    return;
                }

                const usefulBtn = document.getElementById('usefulBtn');
                const notusefulBtn = document.getElementById('notusefulBtn');
                
                usefulBtn.disabled = true;
                notusefulBtn.disabled = true;

                try {
                    const postId = getPostId();
                    const response = await fetch(`/api/posts/${postId}/reactions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reaction_type: reactionType })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Smooth number update with animation
                        const usefulCountEl = document.getElementById('usefulCount');
                        const notusefulCountEl = document.getElementById('notusefulCount');
                        
                        usefulCountEl.style.transition = 'all 0.3s ease';
                        notusefulCountEl.style.transition = 'all 0.3s ease';
                        
                        usefulCountEl.textContent = data.useful;
                        notusefulCountEl.textContent = data.notUseful;

                        // bump animation
                        usefulCountEl.classList.remove('count-bump');
                        notusefulCountEl.classList.remove('count-bump');
                        void usefulCountEl.offsetWidth;
                        usefulCountEl.classList.add('count-bump');
                        notusefulCountEl.classList.add('count-bump');
                        
                        currentUserReaction = data.userReaction;
                        updateReactionButtonStyles(data.userReaction);
                        showToast('‚úì Reaction updated!', 'success', 1500);
                    } else if (response.status === 400) {
                        showToast('Already voted this way. Switch or remove your reaction.', 'info', 2000);
                    }
                } catch (err) {
                    console.error('Error submitting reaction:', err);
                    showToast('Error updating reaction', 'error');
                } finally {
                    usefulBtn.disabled = false;
                    notusefulBtn.disabled = false;
                }
            }

            // ===== COMMENTS CODE =====
            async function loadComments(postId) {
                try {
                    const response = await fetch(`/api/posts/${postId}/comments`);
                    if (response.ok) {
                        const comments = await response.json();
                        renderComments(comments);
                    }
                } catch (err) {
                    console.error('Error loading comments:', err);
                }
            }

            function renderComments(comments) {
                const commentsList = document.getElementById('commentsList');
                const noComments = document.getElementById('noComments');
                const commentCount = document.getElementById('commentCount');

                commentCount.textContent = comments.length;

                if (comments.length === 0) {
                    commentsList.innerHTML = '';
                    noComments.style.display = 'block';
                    return;
                }

                noComments.style.display = 'none';
                commentsList.innerHTML = comments.map((comment, index) => {
                    const canEdit = currentUser && currentUser.userId === comment.user_id;
                    const canDelete = currentUser && (currentUser.userId === comment.user_id || currentUser.isAdmin);
                    const isAdminComment = comment.is_admin === 1 || comment.is_admin === true;
                    const nameDisplay = isAdminComment ? 'Admin' : comment.username;
                    const avatarMarkup = isAdminComment
                        ? `<span class="avatar-chip" style="background:linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%)">üëë</span>`
                        : `<span class="avatar-chip" style="background:${avatarStyle(comment.avatar || '')}">${escapeHtml((comment.username || 'U').charAt(0).toUpperCase())}</span>`;
                    return `
                    <div class="comment-card comment-item" style="animation-delay: ${index * 0.05}s;">
                        <div class="comment-meta">
                            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                                ${avatarMarkup}
                                <div>
                                    <strong style="color: #1e3a5f; font-size: 1rem;">${escapeHtml(nameDisplay)}</strong>
                                    <span style="color: #95a5a6; font-size: 0.85rem; margin-left: 10px; letter-spacing: 0.2px;">${formatDate(comment.created_at)}</span>
                                    ${comment.updated_at !== comment.created_at ? `<span style="color: #d4a574; font-size: 0.85rem; margin-left: 8px; font-style: italic;">(edited)</span>` : ''}
                                </div>
                            </div>
                            ${ (canEdit || canDelete) ? `
                                <div class="comment-actions">
                                    ${ canEdit ? `<button class="comment-action-btn edit" onclick="openEdit(${comment.id})">‚úé Edit</button>` : '' }
                                    ${ canDelete ? `<button class="comment-action-btn delete" onclick="deleteComment(${comment.id}, ${comment.post_id})">‚úï Delete</button>` : '' }
                                </div>
                            ` : ''}
                        </div>
                        <div id="comment-body-${comment.id}" class="comment-body">${escapeHtml(comment.body).replace(/\n/g, '<br>')}</div>
                        <div id="comment-edit-${comment.id}" class="comment-edit">
                            <textarea id="edit-text-${comment.id}" aria-label="Edit comment">${escapeHtml(comment.body)}</textarea>
                            <div class="comment-edit-actions">
                                <button class="save-btn" onclick="saveEdit(${comment.id}, ${comment.post_id})">Save</button>
                                <button class="cancel-btn" onclick="cancelEdit(${comment.id})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            async function submitComment(e) {
                e.preventDefault();
                if (!currentUser || (!currentUser.userId && !currentUser.isAdmin)) {
                    window.location.href = '/login.html';
                    return;
                }

                const body = document.getElementById('commentBody').value.trim();
                if (!body) {
                    showToast('Comment cannot be empty', 'error');
                    return;
                }

                const submitBtn = document.getElementById('submitCommentBtn');
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Posting...';

                try {
                    const postId = getPostId();
                    const response = await fetch(`/api/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ body })
                    });

                    if (response.ok) {
                        document.getElementById('commentBody').value = '';
                        document.getElementById('commentForm').style.display = 'none';
                        submitBtn.textContent = '‚úì Posted!';
                        showToast('‚úì Comment posted successfully!', 'success', 2000);
                        
                        setTimeout(() => {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }, 500);
                        
                        loadComments(postId);
                    } else {
                        const err = await response.json();
                        showToast(err.error || 'Failed to post comment', 'error');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (err) {
                    console.error('Error posting comment:', err);
                    showToast('Error posting comment', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            function openEdit(commentId) {
                // hide any other open edits
                document.querySelectorAll('.comment-edit.show').forEach(el => {
                    el.classList.remove('show');
                });
                document.querySelectorAll('.comment-body').forEach(el => {
                    el.style.display = 'block';
                });

                const bodyEl = document.getElementById(`comment-body-${commentId}`);
                const editEl = document.getElementById(`comment-edit-${commentId}`);
                if (bodyEl && editEl) {
                    bodyEl.style.display = 'none';
                    editEl.classList.add('show');
                    const textarea = document.getElementById(`edit-text-${commentId}`);
                    if (textarea) {
                        textarea.focus();
                        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                    }
                }
            }

            function cancelEdit(commentId) {
                const bodyEl = document.getElementById(`comment-body-${commentId}`);
                const editEl = document.getElementById(`comment-edit-${commentId}`);
                if (bodyEl && editEl) {
                    bodyEl.style.display = 'block';
                    editEl.classList.remove('show');
                }
            }

            async function saveEdit(commentId, postId) {
                const textarea = document.getElementById(`edit-text-${commentId}`);
                if (!textarea) return;
                const newBody = textarea.value.trim();
                if (!newBody) {
                    showToast('Comment cannot be empty', 'error');
                    return;
                }

                const editContainer = document.getElementById(`comment-edit-${commentId}`);
                const buttons = editContainer ? editContainer.querySelectorAll('button') : [];
                buttons.forEach(btn => btn.disabled = true);

                try {
                    const response = await fetch(`/api/comments/${commentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ body: newBody })
                    });

                    if (response.ok) {
                        showToast('‚úì Comment updated!', 'success', 1500);
                        loadComments(postId);
                    } else {
                        const err = await response.json();
                        showToast(err.error || 'Failed to update comment', 'error');
                    }
                } catch (err) {
                    console.error('Error editing comment:', err);
                    showToast('Error editing comment', 'error');
                } finally {
                    buttons.forEach(btn => btn.disabled = false);
                }
            }

            async function deleteComment(commentId, postId) {
                if (!confirm('Delete this comment? This action cannot be undone.')) return;

                try {
                    const response = await fetch(`/api/comments/${commentId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showToast('‚úì Comment deleted!', 'success', 1500);
                        loadComments(postId);
                    } else {
                        const err = await response.json();
                        showToast(err.error || 'Failed to delete comment', 'error');
                    }
                } catch (err) {
                    console.error('Error deleting comment:', err);
                    showToast('Error deleting comment', 'error');
                }
            }

            // Initialize page
            async function initializePage() {
                const postId = getPostId();

                if (!postId) {
                    showError('No post ID provided. Please go back and select a post.');
                    return;
                }

                LOADING.style.display = 'block';
                const post = await fetchPost(postId);

                if (post) {
                    renderPost(post);
                    
                    // Load reactions and comments
                    currentUser = await fetchCurrentUser();
                    loadReactions(postId);
                    loadComments(postId);

                    // Show/hide reactions and comments UI based on login status
                    const usefulBtn = document.getElementById('usefulBtn');
                    const notusefulBtn = document.getElementById('notusefulBtn');
                    const reactLoginPrompt = document.getElementById('reactLoginPrompt');
                    const commentForm = document.getElementById('commentForm');
                    const commentLoginPrompt = document.getElementById('commentLoginPrompt');

                    // Check if user is authenticated (user OR admin)
                    const isAuthenticated = currentUser && (currentUser.userId || currentUser.isAdmin);

                    if (isAuthenticated) {
                        usefulBtn.style.display = 'inline-block';
                        notusefulBtn.style.display = 'inline-block';
                        reactLoginPrompt.style.display = 'none';
                        commentForm.style.display = 'block';
                        commentLoginPrompt.style.display = 'none';

                        usefulBtn.onclick = () => submitReaction('useful');
                        notusefulBtn.onclick = () => submitReaction('notuseful');

                        // Add "Comment" button to post
                        const postActions = document.querySelector('.post-actions');
                        if (postActions && !document.getElementById('commentBtn')) {
                            const commentBtn = document.createElement('button');
                            commentBtn.id = 'commentBtn';
                            commentBtn.className = 'btn-home';
                            commentBtn.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                            commentBtn.style.transition = 'all 0.3s ease';
                            commentBtn.textContent = 'üí¨ Comment';
                            commentBtn.onmouseover = function() {
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 6px 20px rgba(39, 174, 96, 0.3)';
                            };
                            commentBtn.onmouseout = function() {
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                            };
                            commentBtn.onclick = () => {
                                document.getElementById('commentForm').style.display = 'block';
                                document.getElementById('commentBody').focus();
                                // Smooth scroll to form
                                document.getElementById('commentForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            };
                            postActions.appendChild(commentBtn);
                        }
                    } else {
                        usefulBtn.style.display = 'none';
                        notusefulBtn.style.display = 'none';
                        reactLoginPrompt.style.display = 'inline-block';
                        commentForm.style.display = 'none';
                        commentLoginPrompt.style.display = 'block';
                    }
                }
            }

            window.addEventListener('load', initializePage);
        </script>
    </body>
</html>
