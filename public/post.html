<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Blog Post</title>
        <script src="/csrf.js"></script>
        <script src="/page-transitions.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Trebuchet MS, sans-serif;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                min-height: 100vh;
                padding: 40px 20px;
            }

            .post-header {
                max-width: 900px;
                margin: 0 auto 30px;
                text-align: center;
            }

            .nav-back {
                display: inline-block;
                margin-bottom: 20px;
                color: #d4a574;
                text-decoration: none;
                font-weight: 600;
                font-size: 0.95rem;
                transition: color 0.3s ease;
                letter-spacing: 0.5px;
            }

            .nav-back:hover {
                color: #e8b896;
            }

            h1 {
                color: #1e3a5f;
                font-size: 2.8rem;
                font-weight: 300;
                letter-spacing: 1px;
                margin-bottom: 20px;
                line-height: 1.2;
            }

            .post-header h1 {
                color: #1e3a5f;
            }

            .post-meta {
                color: #d4a574;
                font-size: 0.95rem;
                letter-spacing: 0.5px;
                display: flex;
                justify-content: center;
                gap: 20px;
                flex-wrap: wrap;
            }

            .meta-item {
                display: flex;
                align-items: center;
                gap: 6px;
            }

            .avatar-chip {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: #fff;
                box-shadow: 0 4px 10px rgba(0,0,0,0.12);
                text-transform: uppercase;
                flex-shrink: 0;
            }

            .admin-badge {
                display: inline-flex;
                align-items: center;
                padding: 2px 8px;
                border-radius: 999px;
                background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
                color: #fff;
                font-size: 0.65rem;
                font-weight: 700;
                text-transform: uppercase;
                letter-spacing: 0.5px;
                margin-left: 6px;
                box-shadow: 0 2px 6px rgba(139, 92, 246, 0.3);
            }

            .loading {
                text-align: center;
                color: #ffffff;
                padding: 60px 20px;
                font-size: 1.1rem;
            }

            .spinner {
                display: inline-block;
                width: 50px;
                height: 50px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top-color: #ffffff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 20px;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .post-container {
                max-width: 900px;
                margin: 0 auto;
                background: #ffffff;
                border-radius: 12px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                padding: 60px 50px;
                opacity: 0;
                animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .post-divider {
                height: 3px;
                background: linear-gradient(to right, #d4a574 0%, transparent 100%);
                margin: 40px 0;
            }

            .post-body {
                color: #2c3e50;
                font-size: 1.1rem;
                line-height: 1.9;
                margin-bottom: 40px;
                word-wrap: break-word;
                overflow-wrap: break-word;
                white-space: pre-wrap;
            }

            .post-footer {
                padding-top: 30px;
                border-top: 2px solid #ecf0f1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                flex-wrap: wrap;
                gap: 20px;
            }

            /* Animation styles */
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            @keyframes scaleIn {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            @keyframes buttonPulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.05); }
                100% { transform: scale(1); }
            }

            .comment-item {
                animation: fadeIn 0.3s ease-out;
            }

            .reaction-btn {
                transition: all 0.2s ease;
            }

            .reaction-btn:active {
                animation: buttonPulse 0.3s ease;
            }

            .reaction-btn:disabled {
                opacity: 0.6;
                cursor: not-allowed;
            }

            /* Animated confirm dialog */
            .confirm-overlay {
                position: fixed;
                inset: 0;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(10, 24, 47, 0.8);
                backdrop-filter: blur(4px);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.22s ease;
                z-index: 12000;
                padding: 20px;
            }

            .confirm-overlay.show {
                display: flex;
                opacity: 1;
                pointer-events: all;
            }

            .confirm-card {
                width: min(460px, 100%);
                background: #ffffff;
                border-radius: 14px;
                padding: 26px 26px 22px;
                box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
                transform: translateY(8px) scale(0.98);
                opacity: 0;
                transition: transform 0.25s ease, opacity 0.25s ease;
            }

            .confirm-overlay.show .confirm-card {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            .confirm-icon {
                width: 52px;
                height: 52px;
                border-radius: 14px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                font-size: 1.3rem;
                box-shadow: 0 8px 20px rgba(231, 76, 60, 0.35);
                margin-bottom: 14px;
            }

            .confirm-card h3 {
                margin: 0 0 8px;
                color: #1e3a5f;
                font-size: 1.2rem;
                letter-spacing: 0.3px;
            }

            .confirm-card p {
                margin: 0 0 18px;
                color: #4a5568;
                line-height: 1.6;
            }

            .confirm-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                flex-wrap: wrap;
            }

            .confirm-btn {
                border: none;
                border-radius: 8px;
                padding: 12px 18px;
                font-weight: 700;
                cursor: pointer;
                transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
                letter-spacing: 0.4px;
                font-size: 0.95rem;
            }

            .confirm-btn:hover {
                transform: translateY(-1px);
            }

            .confirm-btn.ghost {
                background: #f3f4f6;
                color: #1e3a5f;
                box-shadow: inset 0 0 0 1px #d9dce2;
            }

            .confirm-btn.danger {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
            }

            .reaction-btn.is-active-useful {
                box-shadow: 0 6px 14px rgba(39, 174, 96, 0.25);
                transform: translateY(-1px);
                border-color: #27ae60 !important;
            }

            .reaction-btn.is-active-notuseful {
                box-shadow: 0 6px 14px rgba(231, 76, 60, 0.25);
                transform: translateY(-1px);
                border-color: #e74c3c !important;
            }

            .comment-form-container {
                animation: scaleIn 0.3s ease-out;
            }

            /* Comment cards & inline edit */
            .comment-card {
                padding: 20px;
                background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
                border-radius: 10px;
                border-left: 4px solid #d4a574;
                animation: fadeIn 0.3s ease-out;
            }

            .comment-meta {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 12px;
                gap: 12px;
            }

            .comment-actions {
                display: flex;
                gap: 8px;
                flex-shrink: 0;
            }

            .comment-action-btn {
                border: none;
                padding: 6px 12px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.85rem;
                font-weight: 600;
                transition: all 0.2s ease;
                color: #fff;
            }

            .comment-action-btn.edit {
                background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            }

            .comment-action-btn.delete {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            }

            .comment-action-btn:hover {
                transform: translateY(-1px);
                box-shadow: 0 3px 8px rgba(0,0,0,0.12);
            }

            .comment-body {
                color: #2c3e50;
                margin: 12px 0;
                line-height: 1.7;
                word-wrap: break-word;
            }

            .comment-edit {
                display: none;
                animation: scaleIn 0.25s ease-out;
            }

            .comment-edit.show {
                display: block;
            }

            .comment-edit textarea {
                width: 100%;
                min-height: 110px;
                padding: 12px;
                border-radius: 8px;
                border: 2px solid #ecf0f1;
                font-family: inherit;
                font-size: 0.95rem;
                transition: all 0.2s ease;
                color: #2c3e50;
            }

            .comment-edit textarea:focus {
                border-color: #d4a574;
                box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.15);
                outline: none;
            }

            .comment-edit-actions {
                margin-top: 12px;
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
            }

            .comment-edit-actions .save-btn {
                background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
                color: #fff;
                border: none;
                padding: 10px 18px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 700;
                transition: all 0.2s ease;
            }

            .comment-edit-actions .cancel-btn {
                background: #ecf0f1;
                color: #2c3e50;
                border: none;
                padding: 10px 18px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.2s ease;
            }

            .comment-edit-actions button:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            /* Mention styling */
            .mention {
                display: inline-flex;
                align-items: center;
                padding: 2px 6px;
                margin: 0 2px;
                border-radius: 999px;
                background: rgba(212, 165, 116, 0.18);
                color: #b35312;
                font-weight: 700;
                letter-spacing: 0.1px;
                transition: transform 0.18s ease, box-shadow 0.18s ease;
            }
            .mention:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(212, 165, 116, 0.25);
            }
            .mention-hint {
                margin-top: 8px;
                color: #7f8c8d;
                font-size: 0.9rem;
                display: flex;
                gap: 6px;
                align-items: center;
                opacity: 0.9;
                animation: fadeIn 0.3s ease-out;
            }
            .mention-dot {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #d4a574;
                box-shadow: 0 0 0 0 rgba(212, 165, 116, 0.4);
                animation: pulse 1.6s ease-in-out infinite;
            }
            @keyframes pulse {
                0% { box-shadow: 0 0 0 0 rgba(212, 165, 116, 0.4); }
                70% { box-shadow: 0 0 0 10px rgba(212, 165, 116, 0); }
                100% { box-shadow: 0 0 0 0 rgba(212, 165, 116, 0); }
            }

            /* Mention suggestions */
            .mention-suggestions {
                position: absolute;
                z-index: 5000;
                background: #fff;
                border: 1px solid #e6edf5;
                border-radius: 10px;
                box-shadow: 0 12px 32px rgba(0,0,0,0.12);
                padding: 6px;
                width: min(360px, 90vw);
                max-height: 240px;
                overflow-y: auto;
                display: none;
                animation: fadeIn 0.18s ease-out;
            }
            .mention-suggestions.show { display: block; }
            .mention-suggestion {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 8px 10px;
                border-radius: 8px;
                cursor: pointer;
                transition: background 0.15s ease, transform 0.12s ease;
            }
            .mention-suggestion:hover { background: #f6f8fb; transform: translateY(-1px); }
            .mention-suggestion-avatar {
                width: 32px;
                height: 32px;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                color: #fff;
                font-weight: 800;
                font-size: 0.9rem;
            }
            .mention-suggestion-name { color: #1e3a5f; font-weight: 700; }
            .mention-suggestion-admin { color: #d35400; font-weight: 700; font-size: 0.85rem; }

            .count-bump {
                animation: bump 0.35s ease;
            }

            @keyframes bump {
                0% { transform: translateY(0); }
                40% { transform: translateY(-4px); }
                100% { transform: translateY(0); }
            }

            /* Toast Notifications */
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 11000;
                max-width: 400px;
            }

            .toast {
                background: #ffffff;
                padding: 14px 18px;
                border-radius: 10px;
                margin-bottom: 10px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
                border-left: 4px solid #1e3a5f;
            }

            .toast.success { border-left-color: #27ae60; }
            .toast.error { border-left-color: #e74c3c; }
            .toast.info { border-left-color: #4a90e2; }

            .toast-icon { font-size: 1.1rem; }
            .toast-message { flex: 1; font-weight: 600; color: #1e3a5f; }
            .toast-close { cursor: pointer; color: #95a5a6; }

            @keyframes slideIn {
                from { transform: translateX(240px); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }

            /* Notifications UI */
            .notif-btn {
                position: relative;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                color: #ffffff;
                display: none;
            }

            .notif-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                background: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
                color: #fff;
                border-radius: 999px;
                padding: 2px 7px;
                font-size: 0.72rem;
                font-weight: 800;
                box-shadow: 0 6px 16px rgba(0,0,0,0.25);
                display: none;
            }

            .notification-panel {
                position: fixed;
                top: 86px;
                right: 20px;
                width: min(420px, calc(100% - 32px));
                background: rgba(255,255,255,0.97);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.35);
                border: 1px solid rgba(255,255,255,0.5);
                padding: 14px;
                z-index: 11000;
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
                pointer-events: none;
                transition: opacity 0.18s ease, transform 0.2s ease;
            }

            .notification-panel.show {
                opacity: 1;
                transform: translateY(0) scale(1);
                pointer-events: all;
            }

            .notification-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                padding: 6px 6px 10px;
            }

            .notification-title {
                display: flex;
                align-items: center;
                gap: 10px;
                color: #1e3a5f;
                font-weight: 800;
                letter-spacing: 0.3px;
            }

            .notification-actions {
                display: flex;
                gap: 6px;
                align-items: center;
            }

            .notif-chip {
                border: none;
                background: #f3f4f6;
                color: #1e3a5f;
                border-radius: 10px;
                padding: 8px 12px;
                font-weight: 700;
                cursor: pointer;
                transition: transform 0.18s ease, box-shadow 0.18s ease;
            }

            .notif-chip:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }

            .notification-list {
                max-height: 400px;
                overflow-y: auto;
                padding: 4px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .notif-item {
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 12px;
                align-items: center;
                background: linear-gradient(135deg, rgba(212,165,116,0.08) 0%, rgba(30,58,95,0.06) 100%);
                border: 1px solid rgba(0,0,0,0.04);
                border-radius: 12px;
                padding: 12px 12px;
                transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.2s ease;
                cursor: pointer;
            }

            .notif-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(0,0,0,0.12);
            }

            .notif-item.unread {
                background: linear-gradient(135deg, rgba(24,118,210,0.08) 0%, rgba(104,159,56,0.08) 100%);
                border-color: rgba(104,159,56,0.16);
            }

            .notif-icon {
                width: 42px;
                height: 42px;
                border-radius: 12px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                color: #fff;
                box-shadow: 0 6px 16px rgba(0,0,0,0.18);
            }

            .notif-body { display: flex; flex-direction: column; gap: 4px; }
            .notif-message { font-weight: 700; color: #1e3a5f; letter-spacing: 0.2px; }
            .notif-meta { font-size: 0.88rem; color: #6b7280; display: flex; align-items: center; gap: 8px; }
            .notif-pill { padding: 3px 9px; border-radius: 999px; font-weight: 700; font-size: 0.78rem; background: #ecf0f1; color: #1e3a5f; }

            .notif-delete {
                border: none;
                background: #f3f4f6;
                color: #c0392b;
                border-radius: 10px;
                padding: 8px 10px;
                cursor: pointer;
                transition: background 0.16s ease, transform 0.16s ease;
            }

            .notif-delete:hover { background: #fbeaea; transform: translateY(-1px); }
            .notif-empty { text-align: center; color: #6b7280; padding: 20px 10px; }

            @media (max-width: 600px) {
                .notification-panel { right: 10px; left: 10px; top: 74px; width: auto; }
            }

            .post-stats {
                display: flex;
                gap: 30px;
                font-size: 0.95rem;
                color: #7f8c8d;
            }

            .stat-item {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .stat-label {
                color: #95a5a6;
                font-size: 0.85rem;
                font-weight: 500;
                letter-spacing: 0.4px;
                text-transform: uppercase;
            }

            .stat-value {
                color: #d4a574;
                font-weight: 600;
                font-size: 1rem;
            }

            .post-actions {
                display: flex;
                gap: 12px;
            }

            button {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.95rem;
                font-weight: 600;
                letter-spacing: 0.5px;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            }

            .btn-home {
                background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%);
                color: #ffffff;
            }

            .btn-home:hover {
                background: linear-gradient(135deg, #e8b896 0%, #d4a574 100%);
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(212, 165, 116, 0.3);
            }

            .btn-copy {
                background: #ecf0f1;
                color: #2c3e50;
                border: 1px solid #bdc3c7;
            }

            .btn-copy:hover {
                background: #d4a574;
                color: #ffffff;
                border-color: #d4a574;
            }

            .btn-copy.copied {
                background: #27ae60;
                color: #ffffff;
                border-color: #27ae60;
            }

            .btn-bookmark {
                background: #fff8ef;
                color: #b9834a;
                border: 1px solid rgba(212, 165, 116, 0.35);
            }

            .btn-bookmark:hover {
                background: linear-gradient(135deg, #f4e3c1 0%, #d4a574 100%);
                color: #1e3a5f;
                border-color: transparent;
            }

            .btn-bookmark.active {
                background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%);
                color: #ffffff;
                border-color: transparent;
            }

            .error-container {
                max-width: 900px;
                margin: 0 auto;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                padding: 40px;
                border-radius: 12px;
                text-align: center;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            }

            .error-icon {
                font-size: 3rem;
                margin-bottom: 16px;
            }

            .error-title {
                font-size: 1.5rem;
                font-weight: 600;
                margin-bottom: 10px;
                letter-spacing: 0.5px;
            }

            .error-text {
                font-size: 1rem;
                margin-bottom: 25px;
                opacity: 0.95;
            }

            .error-back {
                display: inline-block;
                background: rgba(255, 255, 255, 0.2);
                color: #ffffff;
                padding: 12px 24px;
                border-radius: 6px;
                text-decoration: none;
                font-weight: 600;
                transition: all 0.3s ease;
            }

            .error-back:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 1.8rem;
                }

                .post-container {
                    padding: 30px 20px;
                }

                .post-body {
                    font-size: 1rem;
                    line-height: 1.8;
                }

                .post-footer {
                    flex-direction: column;
                    align-items: flex-start;
                }

                .post-stats {
                    flex-wrap: wrap;
                    gap: 20px;
                }

                .post-actions {
                    width: 100%;
                }

                button {
                    flex: 1;
                    min-width: 120px;
                }
            }

            /* ========== READING MODE ========== */
            .reading-mode-btn {
                position: fixed !important;
                bottom: 30px !important;
                right: 30px !important;
                left: auto !important;
                top: auto !important;
                z-index: 9000;
                width: 56px;
                height: 56px;
                min-width: 56px;
                border-radius: 50%;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                color: #fff;
                border: none;
                box-shadow: 0 8px 30px rgba(30, 58, 95, 0.4);
                cursor: pointer;
                font-size: 1.4rem;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                padding: 0;
                margin: 0;
                opacity: 0;
                pointer-events: none;
            }

            .reading-mode-btn:hover {
                transform: scale(1.1) translateY(-2px);
                box-shadow: 0 12px 40px rgba(30, 58, 95, 0.5);
            }

            .reading-mode-btn.ready {
                opacity: 1;
                pointer-events: auto;
            }

            .reading-mode-btn .tooltip {
                position: absolute;
                right: 70px;
                background: #1e3a5f;
                color: #fff;
                padding: 8px 14px;
                border-radius: 8px;
                font-size: 0.85rem;
                font-weight: 600;
                white-space: nowrap;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.2s ease;
            }

            .reading-mode-btn:hover .tooltip {
                opacity: 1;
            }

            /* Reading Mode Overlay */
            .reading-overlay {
                position: fixed;
                inset: 0;
                z-index: 50000;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.4s ease, visibility 0.4s ease;
                background: var(--reading-bg, #f5f1eb);
                color: var(--reading-text, #5b4636);
            }

            .reading-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            .reading-overlay .reading-backdrop {
                display: none;
            }

            .reading-overlay .reading-container {
                position: relative;
                z-index: 1;
                height: 100%;
                overflow-y: auto;
                padding: 60px 40px 100px;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .reading-overlay .reading-content {
                max-width: var(--reading-width, 700px);
                width: 100%;
                color: var(--reading-text, #5b4636);
                font-size: var(--reading-font-size, 1.2rem);
                line-height: var(--reading-line-height, 1.9);
                font-family: Georgia, 'Times New Roman', serif;
                transition: all 0.3s ease;
                background: transparent;
            }

            .reading-overlay .reading-title {
                font-size: 2.4rem;
                font-weight: 400;
                margin-bottom: 20px;
                color: var(--reading-title, #3d2914);
                line-height: 1.3;
                letter-spacing: 0.5px;
            }

            .reading-overlay .reading-meta {
                font-size: 0.95rem;
                color: var(--reading-meta, #8b7355);
                margin-bottom: 40px;
                padding-bottom: 30px;
                border-bottom: 1px solid var(--reading-border, #e0dbd4);
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
            }

            .reading-overlay .reading-body {
                white-space: pre-wrap;
                color: inherit;
            }

            /* Reading Mode Controls */
            .reading-controls {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 50002;
                display: flex;
                gap: 10px;
                align-items: center;
                background: var(--reading-control-bg, rgba(255,255,255,0.95));
                backdrop-filter: blur(10px);
                padding: 12px 16px;
                border-radius: 14px;
                box-shadow: 0 8px 30px rgba(0,0,0,0.12);
                opacity: 0;
                transform: translateY(-20px);
                transition: all 0.3s ease;
            }

            .reading-overlay.active .reading-controls {
                opacity: 1;
                transform: translateY(0);
                transition-delay: 0.2s;
            }

            .reading-control-btn {
                width: 40px;
                height: 40px;
                border-radius: 10px;
                border: none;
                background: var(--reading-btn-bg, #f0ebe4);
                color: var(--reading-btn-text, #1e3a5f);
                cursor: pointer;
                font-size: 1rem;
                font-weight: 700;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: all 0.2s ease;
                box-shadow: none;
                padding: 0;
            }

            .reading-control-btn:hover {
                background: var(--reading-btn-hover, #e5dfd7);
                transform: scale(1.05);
            }

            .reading-control-btn.active {
                background: #1e3a5f;
                color: #fff;
            }

            .reading-control-divider {
                width: 1px;
                height: 28px;
                background: var(--reading-border, #ddd);
                margin: 0 6px;
            }

            .reading-close-btn {
                width: 44px;
                height: 44px;
                border-radius: 12px;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #fff;
                font-size: 1.2rem;
            }

            .reading-close-btn:hover {
                background: linear-gradient(135deg, #ff6b5b 0%, #e74c3c 100%);
            }

            /* Theme Variations */
            .reading-overlay[data-theme="light"] {
                --reading-bg: #ffffff;
                --reading-text: #2c3e50;
                --reading-title: #1e3a5f;
                --reading-meta: #7f8c8d;
                --reading-border: #e8e8e8;
                --reading-control-bg: rgba(255,255,255,0.95);
                --reading-btn-bg: #f5f5f5;
                --reading-btn-text: #2c3e50;
                --reading-btn-hover: #e8e8e8;
            }

            .reading-overlay[data-theme="sepia"] {
                --reading-bg: #f5f1eb;
                --reading-text: #5b4636;
                --reading-title: #3d2914;
                --reading-meta: #8b7355;
                --reading-border: #e0dbd4;
                --reading-control-bg: rgba(245,241,235,0.95);
                --reading-btn-bg: #e8e2d9;
                --reading-btn-text: #5b4636;
                --reading-btn-hover: #ddd6cb;
            }

            .reading-overlay[data-theme="dark"] {
                --reading-bg: #1a1a2e;
                --reading-text: #e0e0e0;
                --reading-title: #ffffff;
                --reading-meta: #888;
                --reading-border: #333;
                --reading-control-bg: rgba(30,30,50,0.95);
                --reading-btn-bg: #2a2a4a;
                --reading-btn-text: #e0e0e0;
                --reading-btn-hover: #3a3a5a;
            }

            /* Progress Bar */
            .reading-progress {
                position: fixed;
                top: 0;
                left: 0;
                height: 4px;
                background: linear-gradient(90deg, #d4a574 0%, #e8b896 100%);
                z-index: 50003;
                width: 0%;
                transition: width 0.1s ease;
            }

            @media (max-width: 768px) {
                .reading-mode-btn {
                    bottom: 20px;
                    right: 20px;
                    width: 50px;
                    height: 50px;
                    font-size: 1.2rem;
                }

                .reading-overlay .reading-container {
                    padding: 50px 20px 80px;
                }

                .reading-overlay .reading-title {
                    font-size: 1.8rem;
                }

                .reading-controls {
                    top: auto;
                    bottom: 20px;
                    right: 50%;
                    transform: translateX(50%) translateY(20px);
                    flex-wrap: wrap;
                    justify-content: center;
                    max-width: calc(100% - 40px);
                }

                .reading-overlay.active .reading-controls {
                    transform: translateX(50%) translateY(0);
                }
            }
        </style>
    </head>
    <body>
        <div class="toast-container" id="toastContainer"></div>

        <!-- Reading Mode Button -->
        <button class="reading-mode-btn" id="readingModeBtn" aria-label="Enter reading mode">
            üìñ
            <span class="tooltip">Reading Mode</span>
        </button>

        <!-- Reading Mode Overlay -->
        <div class="reading-overlay" id="readingOverlay" data-theme="sepia">
            <div class="reading-progress" id="readingProgress"></div>
            <div class="reading-controls">
                <button class="reading-control-btn" id="fontDecrease" title="Decrease font size">A-</button>
                <button class="reading-control-btn" id="fontIncrease" title="Increase font size">A+</button>
                <div class="reading-control-divider"></div>
                <button class="reading-control-btn" id="lineHeightDecrease" title="Decrease line spacing">‚â°</button>
                <button class="reading-control-btn" id="lineHeightIncrease" title="Increase line spacing">‚ò∞</button>
                <div class="reading-control-divider"></div>
                <button class="reading-control-btn" id="themeLight" title="Light theme">‚òÄ</button>
                <button class="reading-control-btn active" id="themeSepia" title="Sepia theme">üìú</button>
                <button class="reading-control-btn" id="themeDark" title="Dark theme">üåô</button>
                <div class="reading-control-divider"></div>
                <button class="reading-control-btn reading-close-btn" id="readingClose" title="Exit reading mode">‚úï</button>
            </div>
            <div class="reading-backdrop"></div>
            <div class="reading-container" id="readingContainer">
                <div class="reading-content" style="color: #5b4636;">
                    <h1 class="reading-title" id="readingTitle" style="color: #3d2914;"></h1>
                    <div class="reading-meta" id="readingMeta" style="color: #8b7355;"></div>
                    <div class="reading-body" id="readingBody"></div>
                </div>
            </div>
        </div>

        <div class="notification-panel" id="notificationPanel" aria-live="polite">
            <div class="notification-header">
                <div class="notification-title">‚ú® Notifications</div>
                <div class="notification-actions">
                    <button class="notif-chip" id="notifRefresh" aria-label="Refresh notifications">‚Üª Refresh</button>
                    <button class="notif-chip" id="notifClose" aria-label="Close notifications">‚úñ Close</button>
                </div>
            </div>
            <div id="notificationList" class="notification-list"></div>
            <div id="notificationEmpty" class="notif-empty" style="display:none;">No notifications yet. Interactions on your posts will appear here.</div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Loading post...</p>
        </div>

        <div id="post-wrapper" style="display: none;">
            <div class="post-header">
                <a href="/" class="nav-back">‚Üê Back to Blog</a>
                <button id="notifications-btn" class="notif-btn" style="display:none; margin-left:10px;">üîî Notifications <span id="notifBadge" class="notif-badge">0</span></button>
                <form id="post-search-form" style="display:inline-block; margin-left:12px;">
                    <input id="post-search-input" type="search" placeholder="Search blog..." style="padding:8px 10px;border-radius:8px;border:1px solid #dfe6ea;" />
                    <button id="post-search-btn" type="submit" style="padding:8px 10px;border-radius:8px;border:none;margin-left:6px;background:#d4a574;color:#fff;">üîé</button>
                </form>
            </div>

            <div class="post-container">
                <div class="post-header">
                    <h1 id="postTitle"></h1>                    <div id="flagNotice" style="display:none; background:#fee; color:#c33; padding:16px; border-radius:6px; margin-bottom:20px; font-weight:600; text-align:center;">
                        üö© This post has been flagged by an administrator
                    </div>                    <div class="post-meta">
                        <div class="meta-item">
                            üìÖ <span id="postDate"></span>
                        </div>
                        <div class="meta-item">
                                <span id="authorName">Unknown</span>
                        </div>
                        <div class="meta-item">
                            üìù <span id="wordCount">0</span> words
                        </div>
                        <div class="meta-item">
                            ‚è±Ô∏è <span id="readTime">0</span> min read
                        </div>
                    </div>
                </div>

                <div class="post-divider"></div>

                <p class="post-body" id="postBody"></p>

                <div class="post-footer">
                    <div class="post-stats">
                        <div class="stat-item">
                            <span class="stat-label">Word Count</span>
                            <span class="stat-value" id="statWordCount">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Published</span>
                            <span class="stat-value" id="statDate"></span>
                        </div>
                    </div>
                    <div class="post-actions">
                        <button class="btn-copy" onclick="copyPostLink()" id="copyBtn">üìã Copy Link</button>
                        <button id="bookmarkBtn" class="btn-bookmark" style="display:none;">üîñ Save</button>
                        <button id="flagBtn" class="btn-home" style="display:none;">üö© Flag</button>
                        <button id="editPostBtn" class="btn-home" style="display:none;">‚úé Edit</button>
                        <button id="deletePostBtn" class="btn-home" style="display:none;">üóë Delete</button>
                        <button class="btn-home" onclick="location.href='/'">üè† Back Home</button>
                    </div>
                </div>

                <!-- Reactions Section -->
                <div style="margin-top: 40px; padding: 30px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); animation: fadeIn 0.5s ease-out;">
                    <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 15px; flex-wrap: wrap;">
                        <span style="font-weight: 600; color: #1e3a5f; font-size: 1.1rem; letter-spacing: 0.3px;">Was this helpful?</span>
                        <button id="usefulBtn" class="reaction-btn" style="display:none; background: linear-gradient(135deg, #f0f9f0 0%, #ffffff 100%); border: 2px solid #27ae60; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #27ae60; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, #d4f1d4 0%, #f0f9f0 100%)'; this.style.boxShadow='0 4px 12px rgba(39, 174, 96, 0.2)';" onmouseout="this.style.background='linear-gradient(135deg, #f0f9f0 0%, #ffffff 100%)'; this.style.boxShadow='none';">üëç <span id="usefulCount">0</span></button>
                        <button id="notusefulBtn" class="reaction-btn" style="display:none; background: linear-gradient(135deg, #fff0f0 0%, #ffffff 100%); border: 2px solid #e74c3c; padding: 12px 20px; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; color: #e74c3c; transition: all 0.3s ease;" onmouseover="this.style.background='linear-gradient(135deg, #fde4e4 0%, #fff0f0 100%)'; this.style.boxShadow='0 4px 12px rgba(231, 76, 60, 0.2)';" onmouseout="this.style.background='linear-gradient(135deg, #fff0f0 0%, #ffffff 100%)'; this.style.boxShadow='none';">üëé <span id="notusefulCount">0</span></button>
                        <span id="reactLoginPrompt" style="color: #7f8c8d; font-size: 0.95rem; padding: 10px 16px; background: #ecf0f1; border-radius: 8px;">üìù <a href="/login.html" style="color: #4a90e2; text-decoration: none; font-weight: 600;">Log in to react</a></span>
                    </div>
                </div>

                <!-- Comments Section -->
                <div style="margin-top: 50px; animation: fadeIn 0.6s ease-out;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 30px;">
                        <h2 style="font-size: 1.5rem; color: #1e3a5f; margin: 0; font-weight: 600; letter-spacing: 0.3px;">üí¨ Comments <span style="background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%); color: #fff; padding: 2px 10px; border-radius: 12px; font-size: 0.9rem; margin-left: 10px;">(<span id="commentCount">0</span>)</span></h2>
                    </div>

                    <!-- Comment Form (only for logged in users) -->
                    <div id="commentForm" style="display: none; margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border-left: 4px solid #d4a574; animation: scaleIn 0.3s ease-out;" class="comment-form-container">
                        <form onsubmit="submitComment(event)">
                            <label style="display: block; margin-bottom: 10px; color: #1e3a5f; font-weight: 600;">Share your thoughts</label>
                            <div style="position: relative;">
                                <textarea id="commentBody" class="mentionable" placeholder="What do you think about this post?" style="width: 100%; padding: 14px; border: 2px solid #ecf0f1; border-radius: 8px; font-family: inherit; font-size: 0.95rem; min-height: 110px; resize: vertical; transition: all 0.3s ease; color: #2c3e50;" onfocus="this.style.borderColor='#d4a574'; this.style.boxShadow='0 0 0 3px rgba(212, 165, 116, 0.1)';" onblur="this.style.borderColor='#ecf0f1'; this.style.boxShadow='none';"></textarea>
                                <div id="mentionSuggestions" class="mention-suggestions"></div>
                            </div>
                            <div class="mention-hint"><span class="mention-dot"></span><span>Type @username to mention someone ‚Äî they‚Äôll get notified.</span></div>
                            <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button type="submit" id="submitCommentBtn" style="background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%); color: #fff; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(212, 165, 116, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(212, 165, 116, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(212, 165, 116, 0.2)';">‚úì Post Comment</button>
                                <button type="button" onclick="document.getElementById('commentForm').style.display='none'; document.getElementById('commentBody').value='';" style="background: #ecf0f1; color: #2c3e50; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s ease;" onmouseover="this.style.background='#ddd';" onmouseout="this.style.background='#ecf0f1';">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <!-- Comment prompt for non-logged-in users -->
                    <div id="commentLoginPrompt" style="display: none; margin-bottom: 30px; padding: 25px; background: linear-gradient(135deg, #e8f4f8 0%, #f0f8fc 100%); border-radius: 12px; text-align: center; color: #1e3a5f; border-left: 4px solid #4a90e2; animation: slideUp 0.3s ease-out;">
                        <p style="margin: 0 0 15px 0; font-weight: 600; font-size: 1.05rem;">üìù Log in to join the conversation</p>
                        <button onclick="window.location.href='/login.html'" style="margin-top: 0; background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%); color: #fff; padding: 10px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(74, 144, 226, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(74, 144, 226, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(74, 144, 226, 0.2)';">Log In or Sign Up</button>
                    </div>

                    <!-- Comments List -->
                    <div id="commentsList" style="display: flex; flex-direction: column; gap: 16px;">
                        <!-- Comments will be inserted here -->
                    </div>

                    <!-- No comments message -->
                    <div id="noComments" style="text-align: center; padding: 50px 30px; color: #95a5a6; background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); border-radius: 12px; animation: fadeIn 0.4s ease-out;">
                        <span style="font-size: 2rem;">üí≠</span>
                        <p style="margin-top: 10px; font-size: 1rem;">No comments yet. Be the first to share your thoughts!</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="error-wrapper" style="display: none;">
            <div class="error-container">
                <div class="error-icon">‚ö†Ô∏è</div>
                <div class="error-title">Post Not Found</div>
                <p class="error-text" id="errorMessage">The post you're looking for doesn't exist.</p>
                <a href="/" class="error-back">‚Üê Back to Blog</a>
            </div>
        </div>

        <script>
            const LOADING = document.getElementById('loading');
            const POST_WRAPPER = document.getElementById('post-wrapper');
            const ERROR_WRAPPER = document.getElementById('error-wrapper');
            const ERROR_MESSAGE = document.getElementById('errorMessage');
            const NOTIF_BTN = document.getElementById('notifications-btn');
            const NOTIF_BADGE = document.getElementById('notifBadge');
            const NOTIF_PANEL = document.getElementById('notificationPanel');
            const NOTIF_LIST = document.getElementById('notificationList');
            const NOTIF_EMPTY = document.getElementById('notificationEmpty');
            const NOTIF_REFRESH = document.getElementById('notifRefresh');
            const NOTIF_CLOSE = document.getElementById('notifClose');
            const BOOKMARK_BTN = document.getElementById('bookmarkBtn');

            const AVATAR_PALETTE = {
                aurora: 'linear-gradient(135deg, #5efce8 0%, #736efe 100%)',
                sunset: 'linear-gradient(135deg, #f83600 0%, #f9d423 100%)',
                wave: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)',
                forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                midnight: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)',
                plum: 'linear-gradient(135deg, #cc2b5e 0%, #753a88 100%)',
                citrus: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
                ember: 'linear-gradient(135deg, #e65c00 0%, #f9d423 100%)',
                mint: 'linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%)',
            };

            function avatarStyle(key) {
                return AVATAR_PALETTE[key] || 'linear-gradient(135deg, #d4a574 0%, #b8956a 100%)';
            }

            let currentUser = null;
            let CURRENT_POST = null;
            let currentUserReaction = null;
            let notifications = [];
            let notifPoll = null;
            let notifPanelOpen = false;

            // Get post ID from URL query parameter
            function getPostId() {
                const params = new URLSearchParams(window.location.search);
                return params.get('id');
            }

            // Count words in text
            function countWords(text) {
                return text.trim().split(/\s+/).length;
            }

            // Estimate reading time (200 words per minute)
            function estimateReadTime(wordCount) {
                return Math.max(1, Math.ceil(wordCount / 200));
            }

            // Format date nicely
            function parseUtc(dateString='') {
                if (!dateString) return Date.now();
                // Treat DB timestamps (UTC) as UTC by appending Z if missing
                return new Date(dateString.includes('Z') ? dateString : `${dateString}Z`).getTime();
            }

            function formatDate(dateString) {
                const date = new Date(parseUtc(dateString));
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            function formatRelative(dateString) {
                const now = Date.now();
                const then = parseUtc(dateString);
                const diffSec = Math.max(0, Math.floor((now - then) / 1000));
                if (diffSec < 5) return 'now';
                if (diffSec < 60) return `${diffSec}s ago`;
                const diffMin = Math.floor(diffSec / 60);
                if (diffMin < 60) return `${diffMin}m ago`;
                const diffHr = Math.floor(diffMin / 60);
                if (diffHr < 24) return `${diffHr}h ago`;
                return formatDate(dateString);
            }

            function timeAgo(dateString) {
                const now = new Date();
                const then = new Date(dateString);
                const diff = Math.max(0, now - then);
                const mins = Math.floor(diff / 60000);
                if (mins < 1) return 'Just now';
                if (mins < 60) return `${mins}m ago`;
                const hours = Math.floor(mins / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                if (days < 7) return `${days}d ago`;
                return formatDate(dateString);
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text = '') {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            // Highlight mentions while keeping content escaped
            function formatMentions(raw = '') {
                const escaped = escapeHtml(raw);
                return escaped.replace(/@([a-zA-Z0-9._-]{3,32})/g, '<span class="mention">@$1</span>');
            }

            // Mention suggestions state
            let mentionTimeout = null;
            let currentMentionQuery = null;
            const mentionBox = document.getElementById('mentionSuggestions');
            const mentionPalette = AVATAR_PALETTE;

            function caretInfo(textarea) {
                return { value: textarea.value, pos: textarea.selectionStart || 0 };
            }

            function findMentionQuery(value, caretPos) {
                const uptoCaret = value.slice(0, caretPos);
                const match = uptoCaret.match(/@([a-zA-Z0-9._-]{2,32})$/);
                if (!match) return null;
                return match[1].toLowerCase();
            }

            function closeMentionBox() {
                if (mentionBox) {
                    mentionBox.classList.remove('show');
                    mentionBox.innerHTML = '';
                }
                currentMentionQuery = null;
            }

            function renderMentionSuggestions(list, insertCb) {
                if (!mentionBox) return;
                if (!list.length) {
                    mentionBox.innerHTML = '<div style="padding:10px; color:#7f8c8d;">No matches</div>';
                    mentionBox.classList.add('show');
                    return;
                }
                mentionBox.innerHTML = list.map(u => {
                    const initial = (u.username || 'U').charAt(0).toUpperCase();
                    const bg = u.avatar ? avatarStyle(u.avatar) : avatarStyle('');
                    const adminTag = u.is_admin ? '<span class="mention-suggestion-admin">ADMIN</span>' : '';
                    return `<div class="mention-suggestion" data-username="${escapeHtml(u.username)}">
                        <span class="mention-suggestion-avatar" style="background:${bg}">${escapeHtml(initial)}</span>
                        <div style="display:flex; flex-direction:column; gap:2px;">
                            <span class="mention-suggestion-name">@${escapeHtml(u.username)}</span>
                            ${adminTag}
                        </div>
                    </div>`;
                }).join('');
                mentionBox.classList.add('show');

                mentionBox.querySelectorAll('.mention-suggestion').forEach(item => {
                    item.addEventListener('mousedown', (e) => {
                        // Prevent textarea blur before we insert the mention
                        e.preventDefault();
                    });
                    item.addEventListener('click', () => {
                        const username = item.getAttribute('data-username');
                        if (!username) return;
                        insertCb(username);
                        closeMentionBox();
                    });
                });
            }

            async function fetchMentionSuggestions(q, insertCb) {
                if (!q || q.length < 2) {
                    closeMentionBox();
                    return;
                }
                try {
                    const resp = await fetch(`/api/users/mention-suggest?q=${encodeURIComponent(q)}`);
                    if (!resp.ok) throw new Error('suggest failed');
                    const data = await resp.json();
                    renderMentionSuggestions(Array.isArray(data) ? data : [], insertCb);
                } catch (err) {
                    console.error('mention suggest error', err);
                    closeMentionBox();
                }
            }

            function attachMentionHandler(textarea) {
                if (!textarea) return;
                textarea.addEventListener('input', () => {
                    const { value, pos } = caretInfo(textarea);
                    const q = findMentionQuery(value, pos);
                    if (!q) {
                        closeMentionBox();
                        return;
                    }

                    currentMentionQuery = q;
                    if (mentionTimeout) clearTimeout(mentionTimeout);
                    mentionTimeout = setTimeout(() => {
                        fetchMentionSuggestions(q, (username) => {
                            const { value: val, pos: caret } = caretInfo(textarea);
                            const before = val.slice(0, caret);
                            const after = val.slice(caret);
                            const replaced = before.replace(/@([a-zA-Z0-9._-]{0,32})$/, `@${username} `);
                            const newVal = replaced + after;
                            const newCaret = replaced.length;
                            textarea.value = newVal;
                            textarea.focus();
                            textarea.setSelectionRange(newCaret, newCaret);
                        });
                    }, 140);
                });

                textarea.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') closeMentionBox();
                });

                textarea.addEventListener('blur', () => {
                    setTimeout(closeMentionBox, 120);
                });

                textarea.addEventListener('click', () => {
                    const { value, pos } = caretInfo(textarea);
                    const q = findMentionQuery(value, pos);
                    if (q && q.length >= 2) {
                        fetchMentionSuggestions(q, (username) => {
                            const { value: val, pos: caret } = caretInfo(textarea);
                            const before = val.slice(0, caret);
                            const after = val.slice(caret);
                            const replaced = before.replace(/@([a-zA-Z0-9._-]{0,32})$/, `@${username} `);
                            const newVal = replaced + after;
                            const newCaret = replaced.length;
                            textarea.value = newVal;
                            textarea.focus();
                            textarea.setSelectionRange(newCaret, newCaret);
                        });
                    }
                });
            }

            function notificationsAllowed() {
                return currentUser && currentUser.userId && !currentUser.isAdmin;
            }

            function stopNotificationPolling() {
                if (notifPoll) {
                    clearInterval(notifPoll);
                    notifPoll = null;
                }
            }

            function startNotificationPolling() {
                stopNotificationPolling();
                notifPoll = setInterval(() => fetchNotifications(true), 20000);
            }

            function updateNotificationBadge() {
                if (!NOTIF_BADGE) return;
                const unread = notifications.filter(n => !n.is_read).length;
                if (unread > 0) {
                    NOTIF_BADGE.style.display = 'inline-block';
                    NOTIF_BADGE.textContent = unread > 99 ? '99+' : unread;
                } else {
                    NOTIF_BADGE.style.display = 'none';
                }
            }

            function refreshRelativeTimes() {
                document.querySelectorAll('[data-timestamp]').forEach(el => {
                    const ts = el.getAttribute('data-timestamp');
                    if (ts) el.textContent = formatRelative(ts);
                });
            }

            function renderNotifications() {
                if (!NOTIF_LIST) return;
                NOTIF_LIST.innerHTML = '';

                if (!notifications.length) {
                    if (NOTIF_EMPTY) NOTIF_EMPTY.style.display = 'block';
                    updateNotificationBadge();
                    return;
                }
                if (NOTIF_EMPTY) NOTIF_EMPTY.style.display = 'none';

                const typeIcons = { flagged: 'üö©', flag_removed: '‚úÖ', reaction: 'üëç', comment: 'üí¨' };
                const typePills = { flagged: 'Flagged', flag_removed: 'Flag removed', reaction: 'Reaction', comment: 'Comment' };

                notifications.forEach((n) => {
                    const item = document.createElement('div');
                    item.className = `notif-item ${n.is_read ? 'read' : 'unread'}`;
                    const icon = typeIcons[n.type] || '‚ú®';
                    const pill = typePills[n.type] || 'Update';
                    item.innerHTML = `
                        <div class="notif-icon">${icon}</div>
                        <div class="notif-body">
                            <div class="notif-message">${escapeHtml(n.message || 'You have a new update')}</div>
                            <div class="notif-meta">
                                <span class="notif-pill">${pill}</span>
                                <span>${timeAgo(n.created_at)}</span>
                            </div>
                        </div>
                        <button class="notif-delete" aria-label="Delete notification">üóë</button>
                    `;

                    item.addEventListener('click', async () => {
                        if (!n.post_id) return;
                        await markNotificationRead(n.id);
                        window.location.href = `/post.html?id=${n.post_id}`;
                    });

                    const delBtn = item.querySelector('.notif-delete');
                    if (delBtn) {
                        delBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            await deleteNotification(n.id);
                        });
                    }

                    NOTIF_LIST.appendChild(item);
                });

                updateNotificationBadge();
            }

            async function fetchNotifications(isBackground = false) {
                if (!notificationsAllowed()) {
                    notifications = [];
                    renderNotifications();
                    return;
                }
                try {
                    const resp = await fetch('/api/notifications');
                    if (!resp.ok) throw new Error('Failed to load notifications');
                    const data = await resp.json();
                    notifications = Array.isArray(data) ? data : [];
                    renderNotifications();
                    if (!isBackground && !notifPanelOpen && notifications.some(n => !n.is_read)) {
                        NOTIF_BADGE.classList.add('count-bump');
                        setTimeout(() => NOTIF_BADGE.classList.remove('count-bump'), 350);
                    }
                } catch (err) {
                    console.error('Notifications error', err);
                    if (!isBackground) showToast('Could not load notifications', 'error');
                }
            }

            async function markNotificationRead(id) {
                const target = notifications.find(n => n.id === id);
                if (target && target.is_read) return true;
                try {
                    const resp = await fetch(`/api/notifications/${id}/read`, { method: 'PATCH' });
                    if (resp.ok) {
                        if (target) target.is_read = 1;
                        updateNotificationBadge();
                        return true;
                    }
                } catch (err) {
                    console.error('Mark read failed', err);
                }
                return false;
            }

            async function deleteNotification(id) {
                try {
                    const resp = await fetch(`/api/notifications/${id}`, { method: 'DELETE' });
                    if (resp.ok) {
                        notifications = notifications.filter(n => n.id !== id);
                        renderNotifications();
                        return true;
                    }
                } catch (err) {
                    console.error('Delete notification failed', err);
                }
                showToast('Could not delete notification', 'error');
                return false;
            }

            function toggleNotificationPanel(force) {
                if (!notificationsAllowed() || !NOTIF_PANEL) return;
                const nextState = force !== undefined ? force : !notifPanelOpen;
                notifPanelOpen = nextState;
                NOTIF_PANEL.classList.toggle('show', nextState);
                if (nextState) {
                    fetchNotifications(true);
                }
            }

            function setNotificationAccess(user) {
                if (!NOTIF_BTN) return;
                if (user && user.userId && !user.isAdmin) {
                    NOTIF_BTN.style.display = 'inline-block';
                    startNotificationPolling();
                    fetchNotifications(true);
                } else {
                    NOTIF_BTN.style.display = 'none';
                    toggleNotificationPanel(false);
                    notifications = [];
                    renderNotifications();
                    stopNotificationPolling();
                }
            }

            if (NOTIF_BTN) NOTIF_BTN.addEventListener('click', () => toggleNotificationPanel());
            if (NOTIF_REFRESH) NOTIF_REFRESH.addEventListener('click', () => fetchNotifications());
            if (NOTIF_CLOSE) NOTIF_CLOSE.addEventListener('click', () => toggleNotificationPanel(false));
            document.addEventListener('click', (e) => {
                if (!notifPanelOpen) return;
                const withinPanel = NOTIF_PANEL && NOTIF_PANEL.contains(e.target);
                const withinBtn = NOTIF_BTN && NOTIF_BTN.contains(e.target);
                if (!withinPanel && !withinBtn) toggleNotificationPanel(false);
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && notifPanelOpen) toggleNotificationPanel(false);
            });

            // Fetch post by ID
            async function fetchPost(postId) {
                try {
                    const response = await fetch(`/api/posts/${postId}`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            showError('The post you\'re looking for doesn\'t exist.');
                        } else {
                            showError('Failed to fetch the post.');
                        }
                        return null;
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Error fetching post:', error);
                    showError('Unable to load the post. Please try again later.');
                    return null;
                }
            }

            // Render post content
            function renderPost(post, viewer = currentUser) {
                const wordCount = countWords(post.body);
                const readTime = estimateReadTime(wordCount);
                const formattedDate = formatDate(post.created_at);
                const authorDisplay = post.author_name || 'Unknown';
                const isAdminPost = post.is_admin_post === 1 || post.author_id === null;
                const authorIsAdmin = post.author_is_admin === 1;
                const authorInitial = authorDisplay.charAt(0).toUpperCase();
                const authorAvatarBg = authorIsAdmin ? 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)' : avatarStyle(post.author_avatar || '');
                const canViewProfiles = viewer && viewer.isAdmin;
                const shouldLinkAuthor = canViewProfiles && !isAdminPost && post.author_id;
                const authorLabel = escapeHtml(authorDisplay);
                const adminBadge = authorIsAdmin ? '<span class="admin-badge">Admin</span>' : '';
                const authorChip = `<span class="avatar-chip" style="background:${authorAvatarBg}">${escapeHtml(authorInitial)}</span><span style="color:${authorIsAdmin ? '#7c3aed' : 'inherit'}">${authorLabel}${adminBadge}</span>`;
                const authorMarkup = shouldLinkAuthor
                    ? `<a href="/view-profile.html?id=${encodeURIComponent(post.author_id)}" style="display:flex; align-items:center; gap:8px; color:${authorIsAdmin ? '#7c3aed' : '#1e3a5f'}; font-weight:700; text-decoration:none;">${authorChip}</a>`
                    : authorChip;

                // Update title
                document.title = `${post.title} | Blog`;
                document.getElementById('postTitle').textContent = escapeHtml(post.title);

                // Show flag notice if post is flagged
                if (post.is_flagged) {
                    document.getElementById('flagNotice').style.display = 'block';
                }

                // Update meta information
                const postDateEl = document.getElementById('postDate');
                postDateEl.textContent = formatRelative(post.created_at);
                postDateEl.dataset.timestamp = post.created_at;
                document.getElementById('wordCount').textContent = wordCount;
                document.getElementById('readTime').textContent = readTime;
                document.getElementById('authorName').innerHTML = isAdminPost
                    ? `<span style="display:flex; align-items:center; gap:8px; color:#1e3a5f; font-weight:700;"><span class="avatar-chip" style="background:linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%)">üëë</span><span>Admin</span></span>`
                    : authorMarkup;

                // Update body with mention highlighting
                const postBody = document.getElementById('postBody');
                postBody.innerHTML = formatMentions(post.body || '').replace(/\n/g, '<br>');

                // Update stats
                document.getElementById('statWordCount').textContent = wordCount;
                document.getElementById('statDate').textContent = formattedDate;

                // Bookmark button (user only)
                if (BOOKMARK_BTN) {
                    const canBookmark = viewer && viewer.userId && !viewer.isAdmin;
                    if (canBookmark) {
                        BOOKMARK_BTN.style.display = 'inline-block';
                        const isBookmarked = post.is_bookmarked === 1 || post.is_bookmarked === true;
                        BOOKMARK_BTN.classList.toggle('active', isBookmarked);
                        BOOKMARK_BTN.textContent = isBookmarked ? 'üîñ Saved' : 'üîñ Save';
                        BOOKMARK_BTN.onclick = async () => {
                            try {
                                const resp = await fetch(`/api/posts/${post.id}/bookmark`, { method: 'POST' });
                                if (resp.ok) {
                                    const data = await resp.json();
                                    const saved = data.bookmarked === true;
                                    BOOKMARK_BTN.classList.toggle('active', saved);
                                    BOOKMARK_BTN.textContent = saved ? 'üîñ Saved' : 'üîñ Save';
                                    showToast(saved ? 'Saved to bookmarks' : 'Removed from bookmarks', 'success', 1400);
                                } else {
                                    const err = await resp.json().catch(() => ({}));
                                    showToast(err.error || 'Failed to update bookmark', 'error');
                                }
                            } catch (error) {
                                console.error('Bookmark failed', error);
                                showToast('Failed to update bookmark', 'error');
                            }
                        };
                    } else {
                        BOOKMARK_BTN.style.display = 'none';
                    }
                }

                LOADING.style.display = 'none';
                POST_WRAPPER.style.display = 'block';
                CURRENT_POST = post;
                if (READING_MODE_BTN) {
                    READING_MODE_BTN.classList.add('ready');
                }
                // show admin controls if applicable
                maybeShowAdminActions(post.id, post.author_id);
            }

            // Fetch current user (to show admin controls)
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/api/auth/me');
                    if (response.ok) {
                        const data = await response.json();
                        return { isAdmin: data.isAdmin === true, userId: data.id || data.userId || null, username: data.username };
                    }
                } catch (err) {
                    console.error('fetchCurrentUser failed', err);
                }
                return { isAdmin: false, userId: null };
            }

            // Toast system
            function showToast(message, type='info', duration=3000) {
                const container = document.getElementById('toastContainer');
                if (!container) return;
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<span class="toast-icon">${type==='success'?'‚úì':type==='error'?'‚úï':'‚Ñπ'}</span><div class="toast-message">${message}</div><span class="toast-close">&times;</span>`;
                container.appendChild(toast);
                toast.querySelector('.toast-close').addEventListener('click', () => toast.remove());
                if (duration>0) setTimeout(()=> { if (toast.parentElement) toast.remove(); }, duration);
            }

            function ensureConfirmDialog() {
                if (document.getElementById('confirmOverlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'confirmOverlay';
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-card">
                        <div class="confirm-icon">üóë</div>
                        <h3 id="confirmTitle">Confirm delete</h3>
                        <p id="confirmMessage">This action cannot be undone.</p>
                        <div class="confirm-actions">
                            <button class="confirm-btn ghost" id="confirmCancel">Cancel</button>
                            <button class="confirm-btn danger" id="confirmConfirm">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            function confirmAction(message, confirmLabel = 'Delete', title = 'Are you sure?') {
                ensureConfirmDialog();
                const overlay = document.getElementById('confirmOverlay');
                const messageEl = document.getElementById('confirmMessage');
                const titleEl = document.getElementById('confirmTitle');
                const confirmBtn = document.getElementById('confirmConfirm');
                const cancelBtn = document.getElementById('confirmCancel');

                messageEl.textContent = message;
                titleEl.textContent = title;
                confirmBtn.textContent = confirmLabel;

                overlay.style.display = 'flex';
                requestAnimationFrame(() => overlay.classList.add('show'));

                return new Promise((resolve) => {
                    const cleanup = (result) => {
                        overlay.classList.remove('show');
                        setTimeout(() => { overlay.style.display = 'none'; }, 220);
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        overlay.onclick = null;
                        resolve(result);
                    };

                    confirmBtn.onclick = (e) => { e.stopPropagation(); cleanup(true); };
                    cancelBtn.onclick = (e) => { e.stopPropagation(); cleanup(false); };
                    overlay.onclick = (e) => {
                        if (e.target === overlay) cleanup(false);
                    };
                });
            }

            // Show admin actions (edit/delete/flag)
            async function maybeShowAdminActions(postId, authorId) {
                const user = await fetchCurrentUser();

                // Check permissions
                let canEdit = false;
                let canDelete = false;
                let canFlag = false;

                if (user.isAdmin) {
                    canEdit = authorId === null; // Admin can only edit own posts
                    canDelete = true; // Admin can delete any
                    canFlag = true; // Admin can flag any
                } else if (user.userId) {
                    canEdit = authorId === user.userId; // User can only edit own
                    canDelete = authorId === user.userId; // User can only delete own
                }

                // Flag button (admin only)
                if (canFlag) {
                    const flagBtn = document.getElementById('flagBtn');
                    flagBtn.style.display = 'inline-block';
                    flagBtn.textContent = document.getElementById('flagNotice').style.display === 'block' ? '‚úì Unflag' : 'üö© Flag';
                    flagBtn.onclick = async (e) => {
                        e.preventDefault();
                        const isFlagged = document.getElementById('flagNotice').style.display === 'block';
                        try {
                            const resp = await fetch(`/api/posts/${postId}/flag`, {
                                method: 'PATCH',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ flag: !isFlagged })
                            });
                            if (resp.ok) {
                                if (!isFlagged) {
                                    document.getElementById('flagNotice').style.display = 'block';
                                    flagBtn.textContent = '‚úì Unflag';
                                    showToast('Post flagged', 'success', 1800);
                                } else {
                                    document.getElementById('flagNotice').style.display = 'none';
                                    flagBtn.textContent = 'üö© Flag';
                                    showToast('Post unflagged', 'success', 1200);
                                }
                            } else {
                                const err = await resp.json().catch(()=>({error:'Failed to flag/unflag'}));
                                showToast(err.error || 'Failed to flag/unflag post', 'error');
                            }
                        } catch (error) {
                            console.error('Flag error:', error);
                            showToast('Error flagging post', 'error');
                        }
                    };
                }

                // Edit button
                if (canEdit) {
                    const editBtn = document.getElementById('editPostBtn');
                    editBtn.style.display = 'inline-block';
                    editBtn.onclick = (e) => {
                        e.preventDefault();
                        window.location.href = `/create-post.html?id=${postId}&edit=1`;
                    };
                }

                // Delete button
                if (canDelete) {
                    const deleteBtn = document.getElementById('deletePostBtn');
                    deleteBtn.style.display = 'inline-block';
                    deleteBtn.onclick = async (e) => {
                        e.preventDefault();
                        const confirmed = await confirmAction('Delete this post? This action cannot be undone.', 'Delete post', 'Delete post?');
                        if (!confirmed) return;
                        try {
                            const resp = await fetch(`/api/posts/${postId}`, { method: 'DELETE' });
                                if (resp.ok) {
                                window.location.href = '/';
                            } else {
                                const err = await resp.json().catch(()=>({error:'Failed to delete post'}));
                                showToast(err.error || 'Failed to delete post', 'error');
                            }
                        } catch (error) {
                            console.error('Delete error:', error);
                            showToast('Error deleting post', 'error');
                        }
                    };
                }
            }


            // Show error message
            function showError(message) {
                ERROR_MESSAGE.textContent = message;
                LOADING.style.display = 'none';
                ERROR_WRAPPER.style.display = 'block';
            }

            // Copy post link to clipboard
            async function copyPostLink() {
                const postId = getPostId();
                const link = `${window.location.origin}/post.html?id=${postId}`;
                
                try {
                    await navigator.clipboard.writeText(link);
                    const btn = document.getElementById('copyBtn');
                    const originalText = btn.textContent;
                    
                    btn.textContent = '‚úì Copied!';
                    btn.classList.add('copied');

                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.classList.remove('copied');
                    }, 2000);
                } catch (err) {
                    console.error('Failed to copy:', err);
                    showToast('Failed to copy link', 'error');
                }
            }

            // Load on page ready
            // Wire up inline search from post page
            const POST_SEARCH_FORM = document.getElementById('post-search-form');
            const POST_SEARCH_INPUT = document.getElementById('post-search-input');
            if (POST_SEARCH_FORM) {
                POST_SEARCH_FORM.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const q = (POST_SEARCH_INPUT.value || '').toString().trim();
                    if (!q) return;
                    window.location.href = `/?q=${encodeURIComponent(q)}`;
                });
            }

            // ===== REACTIONS CODE =====

            async function loadReactions(postId) {
                try {
                    const response = await fetch(`/api/posts/${postId}/reactions`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('usefulCount').textContent = data.useful;
                        document.getElementById('notusefulCount').textContent = data.notUseful;
                        currentUserReaction = data.userReaction;
                        updateReactionButtonStyles(data.userReaction);
                    }
                } catch (err) {
                    console.error('Error loading reactions:', err);
                }
            }

            function updateReactionButtonStyles(userReaction) {
                const usefulBtn = document.getElementById('usefulBtn');
                const notusefulBtn = document.getElementById('notusefulBtn');
                
                usefulBtn.classList.toggle('is-active-useful', userReaction === 'useful');
                notusefulBtn.classList.toggle('is-active-notuseful', userReaction === 'notuseful');

                if (userReaction === 'useful') {
                    usefulBtn.style.borderColor = '#27ae60';
                    usefulBtn.style.background = '#d4f1d4';
                    notusefulBtn.style.borderColor = 'transparent';
                    notusefulBtn.style.background = '#ecf0f1';
                } else if (userReaction === 'notuseful') {
                    notusefulBtn.style.borderColor = '#e74c3c';
                    notusefulBtn.style.background = '#fde4e4';
                    usefulBtn.style.borderColor = 'transparent';
                    usefulBtn.style.background = '#ecf0f1';
                } else {
                    usefulBtn.style.borderColor = 'transparent';
                    usefulBtn.style.background = '#ecf0f1';
                    notusefulBtn.style.borderColor = 'transparent';
                    notusefulBtn.style.background = '#ecf0f1';
                }
            }

            async function submitReaction(reactionType) {
                if (!currentUser || (!currentUser.userId && !currentUser.isAdmin)) {
                    window.location.href = '/login.html';
                    return;
                }

                const usefulBtn = document.getElementById('usefulBtn');
                const notusefulBtn = document.getElementById('notusefulBtn');
                
                usefulBtn.disabled = true;
                notusefulBtn.disabled = true;

                try {
                    const postId = getPostId();
                    const response = await fetch(`/api/posts/${postId}/reactions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ reaction_type: reactionType })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Smooth number update with animation
                        const usefulCountEl = document.getElementById('usefulCount');
                        const notusefulCountEl = document.getElementById('notusefulCount');
                        
                        usefulCountEl.style.transition = 'all 0.3s ease';
                        notusefulCountEl.style.transition = 'all 0.3s ease';
                        
                        usefulCountEl.textContent = data.useful;
                        notusefulCountEl.textContent = data.notUseful;

                        // bump animation
                        usefulCountEl.classList.remove('count-bump');
                        notusefulCountEl.classList.remove('count-bump');
                        void usefulCountEl.offsetWidth;
                        usefulCountEl.classList.add('count-bump');
                        notusefulCountEl.classList.add('count-bump');
                        
                        currentUserReaction = data.userReaction;
                        updateReactionButtonStyles(data.userReaction);
                        showToast('‚úì Reaction updated!', 'success', 1500);
                    } else if (response.status === 400) {
                        showToast('Already voted this way. Switch or remove your reaction.', 'info', 2000);
                    }
                } catch (err) {
                    console.error('Error submitting reaction:', err);
                    showToast('Error updating reaction', 'error');
                } finally {
                    usefulBtn.disabled = false;
                    notusefulBtn.disabled = false;
                }
            }

            // ===== COMMENTS CODE =====
            async function loadComments(postId) {
                try {
                    const response = await fetch(`/api/posts/${postId}/comments`);
                    if (response.ok) {
                        const comments = await response.json();
                        renderComments(comments);
                    }
                } catch (err) {
                    console.error('Error loading comments:', err);
                }
            }

            function renderComments(comments) {
                const commentsList = document.getElementById('commentsList');
                const noComments = document.getElementById('noComments');
                const commentCount = document.getElementById('commentCount');
                const isAdminViewer = currentUser && currentUser.isAdmin;

                commentCount.textContent = comments.length;

                if (comments.length === 0) {
                    commentsList.innerHTML = '';
                    noComments.style.display = 'block';
                    return;
                }

                noComments.style.display = 'none';
                commentsList.innerHTML = comments.map((comment, index) => {
                    const canEdit = currentUser && currentUser.userId === comment.user_id;
                    const canDelete = currentUser && (currentUser.userId === comment.user_id || currentUser.isAdmin);
                    const isAdminComment = comment.is_admin === 1 || comment.is_admin === true;
                    const nameDisplay = comment.username || 'Unknown';
                    const safeName = escapeHtml(nameDisplay);
                    const nameMarkup = isAdminViewer
                        ? `<a href="/view-profile.html?id=${encodeURIComponent(comment.user_id)}" style="color:${isAdminComment ? '#7c3aed' : '#1e3a5f'}; font-weight:700; text-decoration:none;">${safeName}</a>`
                        : `<span style="color:${isAdminComment ? '#7c3aed' : '#1e3a5f'}">${safeName}</span>`;
                    const adminBadgeMarkup = isAdminComment ? `<span class="admin-badge">Admin</span>` : '';
                    const avatarMarkup = isAdminComment
                        ? `<span class="avatar-chip" style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)">${escapeHtml((comment.username || 'A').charAt(0).toUpperCase())}</span>`
                        : `<span class="avatar-chip" style="background:${avatarStyle(comment.avatar || '')}">${escapeHtml((comment.username || 'U').charAt(0).toUpperCase())}</span>`;
                    return `
                    <div class="comment-card comment-item" style="animation-delay: ${index * 0.05}s;">
                        <div class="comment-meta">
                            <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                                ${avatarMarkup}
                                <div>
                                    <strong style="color: #1e3a5f; font-size: 1rem;">${nameMarkup}</strong>${adminBadgeMarkup}
                                    <span class="rel-time" data-timestamp="${comment.created_at}" style="color: #95a5a6; font-size: 0.85rem; margin-left: 10px; letter-spacing: 0.2px;">${formatRelative(comment.created_at)}</span>
                                    ${comment.updated_at !== comment.created_at ? `<span style="color: #d4a574; font-size: 0.85rem; margin-left: 8px; font-style: italic;">(edited)</span>` : ''}
                                </div>
                            </div>
                            ${ (canEdit || canDelete) ? `
                                <div class="comment-actions">
                                    ${ canEdit ? `<button class="comment-action-btn edit" onclick="openEdit(${comment.id})">‚úé Edit</button>` : '' }
                                    ${ canDelete ? `<button class="comment-action-btn delete" onclick="deleteComment(${comment.id}, ${comment.post_id})">‚úï Delete</button>` : '' }
                                </div>
                            ` : ''}
                        </div>
                        <div id="comment-body-${comment.id}" class="comment-body">${formatMentions(comment.body).replace(/\n/g, '<br>')}</div>
                        <div id="comment-edit-${comment.id}" class="comment-edit">
                            <textarea id="edit-text-${comment.id}" aria-label="Edit comment">${escapeHtml(comment.body)}</textarea>
                            <div class="comment-edit-actions">
                                <button class="save-btn" onclick="saveEdit(${comment.id}, ${comment.post_id || 'null'})">Save</button>
                                <button class="cancel-btn" onclick="cancelEdit(${comment.id})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                }).join('');
            }

            async function submitComment(e) {
                e.preventDefault();
                if (!currentUser || (!currentUser.userId && !currentUser.isAdmin)) {
                    window.location.href = '/login.html';
                    return;
                }

                const body = document.getElementById('commentBody').value.trim();
                if (!body) {
                    showToast('Comment cannot be empty', 'error');
                    return;
                }

                const submitBtn = document.getElementById('submitCommentBtn');
                submitBtn.disabled = true;
                const originalText = submitBtn.textContent;
                submitBtn.textContent = '‚è≥ Posting...';

                try {
                    const postId = getPostId();
                    const response = await fetch(`/api/posts/${postId}/comments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ body })
                    });

                    if (response.ok) {
                        document.getElementById('commentBody').value = '';
                        document.getElementById('commentForm').style.display = 'none';
                        submitBtn.textContent = '‚úì Posted!';
                        showToast('‚úì Comment posted successfully!', 'success', 2000);
                        
                        setTimeout(() => {
                            submitBtn.textContent = originalText;
                            submitBtn.disabled = false;
                        }, 500);
                        
                        loadComments(postId);
                    } else {
                        const err = await response.json();
                        showToast(err.error || 'Failed to post comment', 'error');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                } catch (err) {
                    console.error('Error posting comment:', err);
                    showToast('Error posting comment', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            }

            function openEdit(commentId) {
                // hide any other open edits
                document.querySelectorAll('.comment-edit.show').forEach(el => {
                    el.classList.remove('show');
                });
                document.querySelectorAll('.comment-body').forEach(el => {
                    el.style.display = 'block';
                });

                const bodyEl = document.getElementById(`comment-body-${commentId}`);
                const editEl = document.getElementById(`comment-edit-${commentId}`);
                if (bodyEl && editEl) {
                    bodyEl.style.display = 'none';
                    editEl.classList.add('show');
                    const textarea = document.getElementById(`edit-text-${commentId}`);
                    if (textarea) {
                        textarea.focus();
                        textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                    }
                }
            }

            function cancelEdit(commentId) {
                const bodyEl = document.getElementById(`comment-body-${commentId}`);
                const editEl = document.getElementById(`comment-edit-${commentId}`);
                if (bodyEl && editEl) {
                    bodyEl.style.display = 'block';
                    editEl.classList.remove('show');
                }
            }

            async function saveEdit(commentId, postId) {
                const textarea = document.getElementById(`edit-text-${commentId}`);
                if (!textarea) return;
                const newBody = textarea.value.trim();
                if (!newBody) {
                    showToast('Comment cannot be empty', 'error');
                    return;
                }

                const effectivePostId = postId || getPostId();

                const editContainer = document.getElementById(`comment-edit-${commentId}`);
                const buttons = editContainer ? editContainer.querySelectorAll('button') : [];
                buttons.forEach(btn => btn.disabled = true);

                try {
                    const response = await fetch(`/api/comments/${commentId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ body: newBody })
                    });

                    if (response.ok) {
                        showToast('‚úì Comment updated!', 'success', 1500);
                        loadComments(effectivePostId);
                    } else {
                        const err = await response.json();
                        showToast(err.error || 'Failed to update comment', 'error');
                    }
                } catch (err) {
                    console.error('Error editing comment:', err);
                    showToast('Error editing comment', 'error');
                } finally {
                    buttons.forEach(btn => btn.disabled = false);
                }
            }

            async function deleteComment(commentId, postId) {
                const confirmed = await confirmAction('Delete this comment? This action cannot be undone.', 'Delete comment', 'Delete comment?');
                if (!confirmed) return;

                const effectivePostId = postId || getPostId();

                try {
                    const response = await fetch(`/api/comments/${commentId}`, {
                        method: 'DELETE'
                    });

                    if (response.ok) {
                        showToast('‚úì Comment deleted!', 'success', 1500);
                        loadComments(effectivePostId);
                    } else {
                        const err = await response.json();
                        showToast(err.error || 'Failed to delete comment', 'error');
                    }
                } catch (err) {
                    console.error('Error deleting comment:', err);
                    showToast('Error deleting comment', 'error');
                }
            }

            // Initialize page
            async function initializePage() {
                const postId = getPostId();

                if (!postId) {
                    showError('No post ID provided. Please go back and select a post.');
                    return;
                }

                LOADING.style.display = 'block';
                const post = await fetchPost(postId);

                if (post) {
                    currentUser = await fetchCurrentUser();
                    renderPost(post, currentUser);

                    // Load reactions and comments
                    setNotificationAccess(currentUser || { userId: null, isAdmin: false });
                    fetchNotifications(true);
                    loadReactions(postId);
                    loadComments(postId);
                    refreshRelativeTimes();
                    setInterval(refreshRelativeTimes, 60000);

                    // Show/hide reactions and comments UI based on login status
                    const usefulBtn = document.getElementById('usefulBtn');
                    const notusefulBtn = document.getElementById('notusefulBtn');
                    const reactLoginPrompt = document.getElementById('reactLoginPrompt');
                    const commentForm = document.getElementById('commentForm');
                    const commentLoginPrompt = document.getElementById('commentLoginPrompt');

                    // Check if user is authenticated (user OR admin)
                    const isAuthenticated = currentUser && (currentUser.userId || currentUser.isAdmin);

                    if (isAuthenticated) {
                        usefulBtn.style.display = 'inline-block';
                        notusefulBtn.style.display = 'inline-block';
                        reactLoginPrompt.style.display = 'none';
                        commentForm.style.display = 'block';
                        commentLoginPrompt.style.display = 'none';

                        // Wire mention suggestions on comment box
                        attachMentionHandler(document.getElementById('commentBody'));

                        usefulBtn.onclick = () => submitReaction('useful');
                        notusefulBtn.onclick = () => submitReaction('notuseful');

                        // Add "Comment" button to post
                        const postActions = document.querySelector('.post-actions');
                        if (postActions && !document.getElementById('commentBtn')) {
                            const commentBtn = document.createElement('button');
                            commentBtn.id = 'commentBtn';
                            commentBtn.className = 'btn-home';
                            commentBtn.style.background = 'linear-gradient(135deg, #27ae60 0%, #229954 100%)';
                            commentBtn.style.transition = 'all 0.3s ease';
                            commentBtn.textContent = 'üí¨ Comment';
                            commentBtn.onmouseover = function() {
                                this.style.transform = 'translateY(-2px)';
                                this.style.boxShadow = '0 6px 20px rgba(39, 174, 96, 0.3)';
                            };
                            commentBtn.onmouseout = function() {
                                this.style.transform = 'translateY(0)';
                                this.style.boxShadow = '0 4px 15px rgba(0, 0, 0, 0.2)';
                            };
                            commentBtn.onclick = () => {
                                document.getElementById('commentForm').style.display = 'block';
                                document.getElementById('commentBody').focus();
                                // Smooth scroll to form
                                document.getElementById('commentForm').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            };
                            postActions.appendChild(commentBtn);
                        }
                    } else {
                        usefulBtn.style.display = 'none';
                        notusefulBtn.style.display = 'none';
                        reactLoginPrompt.style.display = 'inline-block';
                        commentForm.style.display = 'none';
                        commentLoginPrompt.style.display = 'block';
                    }
                }
            }

            // ========== READING MODE ==========
            const READING_MODE_BTN = document.getElementById('readingModeBtn');
            const READING_OVERLAY = document.getElementById('readingOverlay');
            const READING_CONTAINER = document.getElementById('readingContainer');
            const READING_PROGRESS = document.getElementById('readingProgress');
            const READING_TITLE = document.getElementById('readingTitle');
            const READING_META = document.getElementById('readingMeta');
            const READING_BODY = document.getElementById('readingBody');

            let readingSettings = {
                fontSize: 1.2,
                lineHeight: 1.9,
                theme: 'sepia'
            };

            // Load saved settings
            function loadReadingSettings() {
                try {
                    const saved = localStorage.getItem('readingSettings');
                    if (saved) {
                        readingSettings = { ...readingSettings, ...JSON.parse(saved) };
                    }
                } catch (e) {}
            }

            // Save settings
            function saveReadingSettings() {
                try {
                    localStorage.setItem('readingSettings', JSON.stringify(readingSettings));
                } catch (e) {}
            }

            // Apply settings to overlay
            function applyReadingSettings() {
                if (!READING_OVERLAY) return;
                READING_OVERLAY.style.setProperty('--reading-font-size', readingSettings.fontSize + 'rem');
                READING_OVERLAY.style.setProperty('--reading-line-height', readingSettings.lineHeight);
                READING_OVERLAY.setAttribute('data-theme', readingSettings.theme);

                // Theme color mappings
                const themeColors = {
                    light: { bg: '#ffffff', text: '#2c3e50', title: '#1e3a5f', meta: '#7f8c8d' },
                    sepia: { bg: '#f5f1eb', text: '#5b4636', title: '#3d2914', meta: '#8b7355' },
                    dark: { bg: '#1a1a2e', text: '#e0e0e0', title: '#ffffff', meta: '#888888' }
                };
                const colors = themeColors[readingSettings.theme] || themeColors.sepia;

                // Update inline styles for reliability
                const backdrop = READING_OVERLAY.querySelector('.reading-backdrop');
                const content = READING_OVERLAY.querySelector('.reading-content');
                const title = READING_OVERLAY.querySelector('.reading-title');
                const meta = READING_OVERLAY.querySelector('.reading-meta');

                if (backdrop) backdrop.style.background = colors.bg;
                if (content) content.style.color = colors.text;
                if (title) title.style.color = colors.title;
                if (meta) meta.style.color = colors.meta;

                // Update active theme button
                document.querySelectorAll('#themeLight, #themeSepia, #themeDark').forEach(btn => {
                    btn.classList.remove('active');
                });
                const activeThemeBtn = document.getElementById('theme' + readingSettings.theme.charAt(0).toUpperCase() + readingSettings.theme.slice(1));
                if (activeThemeBtn) activeThemeBtn.classList.add('active');
            }

            // Open reading mode
            function openReadingMode() {
                const title = CURRENT_POST?.title || document.getElementById('postTitle')?.textContent || '';
                const body = (CURRENT_POST?.body || document.getElementById('postBody')?.textContent || '').toString();
                const date = document.getElementById('postDate')?.textContent || '';
                const author = document.getElementById('authorName')?.textContent || '';
                const wordCount = document.getElementById('wordCount')?.textContent || '';
                const readTime = document.getElementById('readTime')?.textContent || '';

                if (!body.trim()) {
                    showToast('Post is still loading. Try again in a second.', 'warning');
                    return;
                }

                READING_TITLE.textContent = title;
                READING_META.innerHTML = `
                    <span>üìÖ ${date}</span>
                    <span>‚úçÔ∏è ${author}</span>
                    <span>üìù ${wordCount} words</span>
                    <span>‚è±Ô∏è ${readTime} min read</span>
                `;
                READING_BODY.textContent = body;

                loadReadingSettings();
                applyReadingSettings();

                READING_OVERLAY.classList.add('active');
                document.body.style.overflow = 'hidden';

                // Reset scroll and progress
                READING_CONTAINER.scrollTop = 0;
                updateReadingProgress();
            }

            // Close reading mode
            function closeReadingMode() {
                READING_OVERLAY.classList.remove('active');
                document.body.style.overflow = '';
            }

            // Update progress bar
            function updateReadingProgress() {
                if (!READING_CONTAINER || !READING_PROGRESS) return;
                const scrollTop = READING_CONTAINER.scrollTop;
                const scrollHeight = READING_CONTAINER.scrollHeight - READING_CONTAINER.clientHeight;
                const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;
                READING_PROGRESS.style.width = progress + '%';
            }

            // Font size controls
            function changeFontSize(delta) {
                readingSettings.fontSize = Math.max(0.9, Math.min(2, readingSettings.fontSize + delta));
                applyReadingSettings();
                saveReadingSettings();
            }

            // Line height controls
            function changeLineHeight(delta) {
                readingSettings.lineHeight = Math.max(1.4, Math.min(2.5, readingSettings.lineHeight + delta));
                applyReadingSettings();
                saveReadingSettings();
            }

            // Theme controls
            function setReadingTheme(theme) {
                readingSettings.theme = theme;
                applyReadingSettings();
                saveReadingSettings();
            }

            // Wire up reading mode controls
            if (READING_MODE_BTN) {
                READING_MODE_BTN.style.position = 'fixed';
                READING_MODE_BTN.style.bottom = '30px';
                READING_MODE_BTN.style.right = '30px';
                READING_MODE_BTN.style.left = 'auto';
                READING_MODE_BTN.style.top = 'auto';
                READING_MODE_BTN.addEventListener('click', openReadingMode);
            }

            if (READING_OVERLAY) {
                document.getElementById('readingClose')?.addEventListener('click', closeReadingMode);
                document.getElementById('fontDecrease')?.addEventListener('click', () => changeFontSize(-0.1));
                document.getElementById('fontIncrease')?.addEventListener('click', () => changeFontSize(0.1));
                document.getElementById('lineHeightDecrease')?.addEventListener('click', () => changeLineHeight(-0.1));
                document.getElementById('lineHeightIncrease')?.addEventListener('click', () => changeLineHeight(0.1));
                document.getElementById('themeLight')?.addEventListener('click', () => setReadingTheme('light'));
                document.getElementById('themeSepia')?.addEventListener('click', () => setReadingTheme('sepia'));
                document.getElementById('themeDark')?.addEventListener('click', () => setReadingTheme('dark'));

                READING_CONTAINER.addEventListener('scroll', updateReadingProgress);

                // Close on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && READING_OVERLAY.classList.contains('active')) {
                        closeReadingMode();
                    }
                });

                // Close on backdrop click
                READING_OVERLAY.querySelector('.reading-backdrop')?.addEventListener('click', closeReadingMode);
            }

            window.addEventListener('load', initializePage);
        </script>
    </body>
</html>
