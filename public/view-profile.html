<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View User - Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Trebuchet MS, sans-serif;
            background: linear-gradient(135deg, #f5f7fb 0%, #e8edf5 100%);
            min-height: 100vh;
            padding: 30px 14px 60px;
        }
        .shell { max-width: 1100px; margin: 0 auto; }
        .nav {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 22px;
        }
        .nav h1 { color: #1e3a5f; font-size: 1.6rem; letter-spacing: 0.5px; }
        .nav-actions { display: flex; gap: 10px; }
        .btn {
            border: none; border-radius: 10px; padding: 10px 16px;
            font-weight: 700; cursor: pointer; transition: transform 0.18s ease, box-shadow 0.18s ease;
            box-shadow: 0 8px 22px rgba(0,0,0,0.12);
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .primary { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%); color:#fff; }
        .ghost { background:#fff; color:#1e3a5f; border:1px solid #dfe6ef; }

        .card {
            background: #fff;
            border-radius: 16px;
            padding: 22px;
            box-shadow: 0 16px 48px rgba(0,0,0,0.14);
            border: 1px solid #e6edf5;
            margin-bottom: 18px;
        }
        .header {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 18px;
            align-items: center;
        }
        .avatar {
            width: 110px; height: 110px; border-radius: 50%;
            display: grid; place-items: center;
            color: #fff; font-weight: 800; font-size: 2.4rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.14);
        }
        .name { color:#1e3a5f; font-size:1.6rem; font-weight:700; }
        .username { color:#d4a574; font-weight:700; margin: 4px 0; }
        .email { color:#52606d; margin-bottom: 6px; }
        .bio { color:#2c3e50; line-height:1.6; }

        .meta-row { display:flex; gap:12px; flex-wrap:wrap; margin-top:12px; }
        .pill { background:#eef2f7; border:1px solid #e0e6ee; border-radius:999px; padding:8px 12px; font-weight:700; color:#52606d; }

        .section-title { color:#1e3a5f; font-size:1.2rem; font-weight:700; margin-bottom:12px; }
        .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:12px; }
        .item-card {
            background: linear-gradient(145deg, #ffffff 0%, #f7f9fc 100%);
            border: 1px solid #e6edf5;
            border-radius: 12px;
            padding: 14px;
            box-shadow: 0 10px 28px rgba(0,0,0,0.1);
            transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
        }
        .item-card:hover { transform: translateY(-2px); box-shadow: 0 12px 32px rgba(0,0,0,0.12); border-color: #d4a574; }
        .item-title { color:#1e3a5f; font-weight:700; margin-bottom:6px; }
        .item-meta { color:#95a5a6; font-size:0.9rem; margin-bottom:6px; }
        .item-body { color:#2c3e50; line-height:1.5; }
        .link { color:#4a90e2; font-weight:700; text-decoration:none; }

        .empty { text-align:center; padding:30px 10px; color:#6b7280; }

        .toast-container { position:fixed; top:20px; right:20px; z-index:10000; max-width:400px; }
        .toast { background:#fff; padding:14px 16px; border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,0.18); display:flex; gap:10px; align-items:center; margin-bottom:10px; }
        .toast.success{border-left:4px solid #4CAF50; }
        .toast.error{border-left:4px solid #f44336; }
        .toast .toast-icon { font-weight:700; }
        .toast .toast-message { flex:1; }

        @media (max-width: 640px) {
            .header { grid-template-columns: 1fr; justify-items: center; text-align:center; }
        }
    </style>
</head>
<body>
<div class="shell">
    <div class="toast-container" id="toastContainer"></div>
    <div class="nav">
        <h1>View User (Admin)</h1>
        <div class="nav-actions">
            <button class="btn ghost" onclick="window.location.href='/admin-users.html'">← Users</button>
            <button class="btn primary" onclick="window.location.href='/admin-profile.html'">Admin Home</button>
        </div>
    </div>

    <div class="card" id="profileCard" style="display:none;">
        <div class="header">
            <div class="avatar" id="avatar">U</div>
            <div>
                <div class="name" id="name">—</div>
                <div class="username" id="username">—</div>
                <div class="email" id="email">—</div>
                <div class="bio" id="bio">—</div>
                <div class="meta-row">
                    <span class="pill" id="joined">Joined: —</span>
                    <span class="pill" id="postCount">Posts: 0</span>
                    <span class="pill" id="commentCount">Comments: 0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="postsCard" style="display:none;">
        <div class="section-title">Posts</div>
        <div class="grid" id="postsGrid"></div>
        <div class="empty" id="postsEmpty" style="display:none;">No posts yet.</div>
    </div>

    <div class="card" id="commentsCard" style="display:none;">
        <div class="section-title">Comments</div>
        <div class="grid" id="commentsGrid"></div>
        <div class="empty" id="commentsEmpty" style="display:none;">No comments yet.</div>
    </div>

    <div class="card" id="errorCard" style="display:none;">
        <div class="section-title" style="color:#c0392b;">Access Restricted</div>
        <p style="color:#721c24;">You must be an admin to view this page.</p>
        <button class="btn primary" onclick="window.location.href='/login.html'">Go to login</button>
    </div>
</div>

<script>
const AVATAR_PALETTE = {
    aurora: 'linear-gradient(135deg, #5efce8 0%, #736efe 100%)',
    sunset: 'linear-gradient(135deg, #f83600 0%, #f9d423 100%)',
    wave: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)',
    forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
    midnight: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)',
    plum: 'linear-gradient(135deg, #cc2b5e 0%, #753a88 100%)',
    citrus: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
    ember: 'linear-gradient(135deg, #e65c00 0%, #f9d423 100%)',
    mint: 'linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%)',
};
const params = new URLSearchParams(window.location.search);
const userId = params.get('id');
const avatarEl = document.getElementById('avatar');
const nameEl = document.getElementById('name');
const usernameEl = document.getElementById('username');
const emailEl = document.getElementById('email');
const bioEl = document.getElementById('bio');
const joinedEl = document.getElementById('joined');
const postCountEl = document.getElementById('postCount');
const commentCountEl = document.getElementById('commentCount');
const postsGrid = document.getElementById('postsGrid');
const postsEmpty = document.getElementById('postsEmpty');
const commentsGrid = document.getElementById('commentsGrid');
const commentsEmpty = document.getElementById('commentsEmpty');
const profileCard = document.getElementById('profileCard');
const postsCard = document.getElementById('postsCard');
const commentsCard = document.getElementById('commentsCard');
const errorCard = document.getElementById('errorCard');

function avatarStyle(key) { return AVATAR_PALETTE[key] || 'linear-gradient(135deg, #d4a574 0%, #b8956a 100%)'; }
function escapeHtml(str='') { return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m])); }
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric' });
}
function showToast(message, type='info', duration=2500) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success:'✓', error:'✕', info:'ℹ', warning:'⚠' };
    toast.innerHTML = `<span class="toast-icon">${icons[type]||icons.info}</span><span class="toast-message">${message}</span><span class="toast-close" style="cursor:pointer;">×</span>`;
    container.appendChild(toast);
    toast.querySelector('.toast-close').onclick = () => toast.remove();
    if (duration>0) setTimeout(()=>toast.remove(), duration);
}

async function ensureAdmin() {
    try {
        const me = await fetch('/api/auth/me').then(r=>r.json());
        if (!me.isAdmin) return false;
        return true;
    } catch (err) {
        return false;
    }
}

async function fetchUserProfile(id) {
    const resp = await fetch(`/api/users/${id}`);
    if (!resp.ok) throw new Error('Failed to load user');
    return resp.json();
}

function renderProfile(user) {
    avatarEl.style.background = avatarStyle(user.avatar || '');
    avatarEl.textContent = (user.username || 'U').charAt(0).toUpperCase();
    nameEl.textContent = user.full_name || user.username || '—';
    usernameEl.textContent = '@' + (user.username || '');
    emailEl.textContent = user.email || '';
    bioEl.textContent = user.bio || 'No bio provided.';
    joinedEl.textContent = 'Joined: ' + (user.created_at ? formatDate(user.created_at) : '—');
    postCountEl.textContent = 'Posts: ' + (user.posts ? user.posts.length : 0);
    commentCountEl.textContent = 'Comments: ' + (user.comments ? user.comments.length : 0);
    profileCard.style.display = 'block';
}

function renderPosts(posts=[]) {
    if (!posts.length) {
        postsEmpty.style.display = 'block';
        postsCard.style.display = 'block';
        return;
    }
    postsCard.style.display = 'block';
    postsEmpty.style.display = 'none';
    postsGrid.innerHTML = posts.map(p => `
        <div class="item-card">
            <div class="item-title">${escapeHtml(p.title)}</div>
            <div class="item-meta">${p.created_at ? formatDate(p.created_at) : ''}</div>
            <div class="item-body">${escapeHtml((p.body||'').slice(0, 160))}${p.body && p.body.length>160 ? '...' : ''}</div>
            <div style="margin-top:8px;"><a class="link" href="/post.html?id=${p.id}">View post →</a></div>
        </div>
    `).join('');
}

function renderComments(comments=[]) {
    if (!comments.length) {
        commentsEmpty.style.display = 'block';
        commentsCard.style.display = 'block';
        return;
    }
    commentsCard.style.display = 'block';
    commentsEmpty.style.display = 'none';
    commentsGrid.innerHTML = comments.map(c => `
        <div class="item-card">
            <div class="item-title">${escapeHtml(c.post_title || 'Post')}</div>
            <div class="item-meta">${c.created_at ? new Date(c.created_at).toLocaleString() : ''}${c.updated_at && c.updated_at !== c.created_at ? ' · edited' : ''}</div>
            <div class="item-body">${escapeHtml((c.body||'').slice(0, 200))}${c.body && c.body.length>200 ? '...' : ''}</div>
            <div style="margin-top:8px;"><a class="link" href="/post.html?id=${c.post_id}">Open post →</a></div>
        </div>
    `).join('');
}

async function init() {
    if (!userId) {
        showToast('No user specified', 'error');
        return;
    }
    const isAdmin = await ensureAdmin();
    if (!isAdmin) {
        errorCard.style.display = 'block';
        return;
    }
    try {
        const user = await fetchUserProfile(userId);
        renderProfile(user);
        renderPosts(user.posts || []);
        renderComments(user.comments || []);
    } catch (err) {
        console.error(err);
        showToast('Unable to load user', 'error');
    }
}

init();
</script>
</body>
</html>
