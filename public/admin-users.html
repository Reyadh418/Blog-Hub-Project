<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Users - Admin</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Trebuchet MS, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(212,165,116,0.18), transparent 28%),
                        radial-gradient(circle at 80% 0%, rgba(30,58,95,0.18), transparent 32%),
                        linear-gradient(135deg, #f8fafc 0%, #eef2f7 100%);
            min-height: 100vh;
            padding: 30px 16px 60px;
        }
        .navbar {
            max-width: 1100px;
            margin: 0 auto 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }
        .nav-title {
            color: #1e3a5f;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.6px;
        }
        .nav-actions { display: flex; gap: 10px; }
        .btn {
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        }
        .btn:hover { transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .primary { background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%); color:#fff; }
        .ghost { background: #fff; color:#1e3a5f; border:1px solid #e0e6ee; }

        .card {
            background: #fff;
            border-radius: 14px;
            padding: 20px 22px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.12);
            border: 1px solid #e8edf2;
            max-width: 1100px;
            margin: 0 auto;
        }
        .toolbar { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        .search-box {
            flex: 1;
            min-width: 240px;
            background: #f4f6fa;
            border: 1px solid #e0e6ee;
            border-radius: 10px;
            padding: 12px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-box input {
            border: none;
            background: transparent;
            flex: 1;
            font-size: 1rem;
            outline: none;
        }
        .pill {
            background: #eef2f7;
            color: #52606d;
            border-radius: 999px;
            padding: 8px 14px;
            font-weight: 700;
            font-size: 0.9rem;
            border: 1px solid #e0e6ee;
        }
        .list {
            margin-top: 18px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 12px;
        }
        .user-card {
            background: linear-gradient(145deg, #ffffff 0%, #f7f9fc 100%);
            border: 1px solid #e6edf5;
            border-radius: 12px;
            padding: 14px;
            display: flex;
            gap: 12px;
            align-items: center;
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease, border-color 0.18s ease;
        }
        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.12);
            border-color: #d4a574;
        }
        .avatar-chip {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #fff;
            text-transform: uppercase;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            flex-shrink: 0;
        }
        .user-meta { display:flex; flex-direction:column; gap:4px; }
        .user-name { color:#1e3a5f; font-weight:700; letter-spacing:0.2px; }
        .user-username { color:#d4a574; font-weight:700; }
        .user-email { color:#6b7280; font-size:0.9rem; }
        .empty { text-align:center; padding:40px 12px; color:#6b7280; }

        .toast-container { position:fixed; top:20px; right:20px; z-index:10000; max-width:400px; }
        .toast { background:#fff; padding:14px 16px; border-radius:10px; box-shadow:0 10px 28px rgba(0,0,0,0.18); display:flex; gap:10px; align-items:center; margin-bottom:10px; }
        .toast.success{border-left:4px solid #4CAF50; }
        .toast.error{border-left:4px solid #f44336; }
        .toast .toast-icon { font-weight:700; }
        .toast .toast-message { flex:1; }

        @media (max-width: 640px) {
            .navbar { flex-direction: column; align-items: flex-start; }
            .nav-actions { width:100%; justify-content:flex-start; flex-wrap: wrap; }
            .list { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    <div class="navbar">
        <div class="nav-title">üë• Registered Users</div>
        <div class="nav-actions">
            <button class="btn ghost" onclick="window.location.href='/admin-profile.html'">‚Üê Admin Home</button>
            <button class="btn primary" onclick="window.location.href='/'">üè† Blog</button>
        </div>
    </div>

    <div class="card">
        <div class="toolbar">
            <div class="search-box">
                <span>üîé</span>
                <input id="searchInput" type="search" placeholder="Search by username" aria-label="Search by username" />
            </div>
            <span class="pill" id="userCountPill">Users: 0</span>
        </div>
        <div class="list" id="usersList"></div>
        <div class="empty" id="emptyState" style="display:none;">No users found.</div>
    </div>

<script>
const AVATAR_PALETTE = {
    aurora: 'linear-gradient(135deg, #5efce8 0%, #736efe 100%)',
    sunset: 'linear-gradient(135deg, #f83600 0%, #f9d423 100%)',
    wave: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)',
    forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
    midnight: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)',
    plum: 'linear-gradient(135deg, #cc2b5e 0%, #753a88 100%)',
    citrus: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
    ember: 'linear-gradient(135deg, #e65c00 0%, #f9d423 100%)',
    mint: 'linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%)',
};
function avatarStyle(key) { return AVATAR_PALETTE[key] || 'linear-gradient(135deg, #d4a574 0%, #b8956a 100%)'; }

const usersList = document.getElementById('usersList');
const emptyState = document.getElementById('emptyState');
const userCountPill = document.getElementById('userCountPill');
const searchInput = document.getElementById('searchInput');
let debounceTimer = null;

function showToast(message, type='info', duration=2600) {
    const container = document.getElementById('toastContainer');
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success:'‚úì', error:'‚úï', info:'‚Ñπ', warning:'‚ö†' };
    toast.innerHTML = `<span class="toast-icon">${icons[type]||icons.info}</span><span class="toast-message">${message}</span><span class="toast-close" style="cursor:pointer;">√ó</span>`;
    container.appendChild(toast);
    toast.querySelector('.toast-close').onclick = () => toast.remove();
    if (duration>0) setTimeout(()=>toast.remove(), duration);
}

async function fetchUsers(search='') {
    try {
        const resp = await fetch(`/api/admin/users${search ? `?search=${encodeURIComponent(search)}` : ''}`);
        if (!resp.ok) throw new Error('Failed');
        return await resp.json();
    } catch (err) {
        console.error('fetchUsers error', err);
        showToast('Unable to load users', 'error');
        return [];
    }
}

function renderUsers(users) {
    usersList.innerHTML = '';
    if (!users || users.length === 0) {
        emptyState.style.display = 'block';
        userCountPill.textContent = 'Users: 0';
        return;
    }
    emptyState.style.display = 'none';
    userCountPill.textContent = `Users: ${users.length}`;
    users.forEach(user => {
        const initial = (user.username || 'U').charAt(0).toUpperCase();
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
            <div class="avatar-chip" style="background:${avatarStyle(user.avatar || '')}">${initial}</div>
            <div class="user-meta">
                <span class="user-name">${escapeHtml(user.full_name || user.username || '')}</span>
                <span class="user-username">@${escapeHtml(user.username || '')}</span>
                <span class="user-email">${escapeHtml(user.email || '')}</span>
            </div>
        `;
        card.addEventListener('click', () => {
            window.location.href = `/view-profile.html?id=${user.id}`;
        });
        usersList.appendChild(card);
    });
}

function escapeHtml(str='') {
    return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#039;'}[m]));
}

async function init() {
    // verify admin session
    try {
        const me = await fetch('/api/auth/me').then(r=>r.json());
        if (!me.isAdmin) {
            window.location.href = '/login.html';
            return;
        }
    } catch (err) {
        window.location.href = '/login.html';
        return;
    }
    const users = await fetchUsers('');
    renderUsers(users);
}

if (searchInput) {
    searchInput.addEventListener('input', (e) => {
        const value = e.target.value || '';
        if (debounceTimer) clearTimeout(debounceTimer);
        debounceTimer = setTimeout(async () => {
            const users = await fetchUsers(value);
            renderUsers(users);
        }, 280);
    });
}

init();
</script>
</body>
</html>
