<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Blog Hub</title>
        <script src="/csrf.js"></script>
        <script src="/page-transitions.js"></script>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: 'Segoe UI', Trebuchet MS, sans-serif;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                min-height: 100vh;
                padding: 40px 20px;
            }

            .header {
                max-width: 900px;
                margin: 0 auto 50px;
                text-align: center;
            }

            h1 {
                color: #ffffff;
                font-size: 3rem;
                font-weight: 300;
                letter-spacing: 2px;
                margin-bottom: 12px;
                text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            }

            .header-subtitle {
                color: #e8d4a5;
                font-size: 1.1rem;
                font-weight: 300;
                letter-spacing: 0.5px;
            }

            .controls {
                max-width: 900px;
                margin: 0 auto 30px;
                display: flex;
                gap: 12px;
                justify-content: center;
                flex-wrap: wrap;
                align-items: center;
            }

            .search-toolbar {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }

            .search-group {
                display: flex;
                gap: 8px;
                align-items: center;
            }

            .search-input {
                padding: 12px 16px;
                border-radius: 10px;
                border: 1px solid rgba(255, 255, 255, 0.15);
                width: 340px;
                max-width: 60vw;
                font-size: 0.95rem;
                background: rgba(255, 255, 255, 0.12);
                color: #f8fbff;
                box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
                backdrop-filter: blur(6px);
                transition: all 0.25s ease;
            }

            .search-input::placeholder {
                color: rgba(255, 255, 255, 0.6);
            }

            .search-input:focus {
                outline: none;
                border-color: rgba(212, 165, 116, 0.8);
                box-shadow: 0 0 0 3px rgba(212, 165, 116, 0.25);
                background: rgba(255, 255, 255, 0.18);
            }

            .sort-dropdown {
                position: relative;
            }

            .sort-btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 12px 16px;
                border-radius: 10px;
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.06) 100%);
                color: #f8fbff;
                border: 1px solid rgba(255, 255, 255, 0.18);
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
                backdrop-filter: blur(8px);
            }

            .sort-btn:hover {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.26) 0%, rgba(255, 255, 255, 0.08) 100%);
            }

            .sort-label {
                font-weight: 600;
                letter-spacing: 0.3px;
                white-space: nowrap;
            }

            .sort-menu {
                position: absolute;
                top: calc(100% + 10px);
                left: 0;
                min-width: 220px;
                background: #ffffff;
                border-radius: 12px;
                box-shadow: 0 18px 50px rgba(15, 23, 42, 0.22);
                padding: 8px;
                display: none;
                z-index: 1000;
                transform-origin: top left;
                animation: sortDrop 0.18s ease;
            }

            .sort-menu.show {
                display: block;
            }

            .sort-option {
                width: 100%;
                text-align: left;
                border: none;
                background: transparent;
                padding: 10px 12px;
                border-radius: 8px;
                color: #1e3a5f;
                font-weight: 600;
                box-shadow: none;
                transform: none;
            }

            .sort-option::before {
                display: none;
            }

            .sort-option:hover,
            .sort-option.active {
                background: #f1f5f9;
                color: #0f172a;
                box-shadow: none;
                transform: none;
            }

            @keyframes sortDrop {
                from {
                    opacity: 0;
                    transform: translateY(-8px) scale(0.98);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            button {
                padding: 12px 24px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.95rem;
                font-weight: 600;
                letter-spacing: 0.5px;
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                position: relative;
                overflow: hidden;
            }

            button::before {
                content: '';
                position: absolute;
                top: 50%;
                left: 50%;
                width: 0;
                height: 0;
                border-radius: 50%;
                background: rgba(255, 255, 255, 0.3);
                transform: translate(-50%, -50%);
                transition: width 0.6s, height 0.6s;
            }

            button:active::before {
                width: 300px;
                height: 300px;
            }

            button:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            }

            button:active {
                transform: translateY(0);
            }

            button:disabled {
                opacity: 0.6;
                cursor: not-allowed;
                transform: none;
            }

            /* Animated confirm dialog */
            .confirm-overlay {
                position: fixed;
                inset: 0;
                display: none;
                align-items: center;
                justify-content: center;
                background: rgba(10, 24, 47, 0.8);
                backdrop-filter: blur(4px);
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.22s ease;
                z-index: 12000;
                padding: 20px;
            }

            .confirm-overlay.show {
                display: flex;
                opacity: 1;
                pointer-events: all;
            }

            .confirm-card {
                width: min(460px, 100%);
                background: #ffffff;
                border-radius: 14px;
                padding: 26px 26px 22px;
                box-shadow: 0 18px 60px rgba(0, 0, 0, 0.35);
                transform: translateY(8px) scale(0.98);
                opacity: 0;
                transition: transform 0.25s ease, opacity 0.25s ease;
            }

            .confirm-overlay.show .confirm-card {
                transform: translateY(0) scale(1);
                opacity: 1;
            }

            .confirm-icon {
                width: 52px;
                height: 52px;
                border-radius: 14px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                font-size: 1.3rem;
                box-shadow: 0 8px 20px rgba(231, 76, 60, 0.35);
                margin-bottom: 14px;
            }

            .confirm-card h3 {
                margin: 0 0 8px;
                color: #1e3a5f;
                font-size: 1.2rem;
                letter-spacing: 0.3px;
            }

            .confirm-card p {
                margin: 0 0 18px;
                color: #4a5568;
                line-height: 1.6;
            }

            .confirm-actions {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                flex-wrap: wrap;
            }

            .confirm-btn {
                border: none;
                border-radius: 8px;
                padding: 12px 18px;
                font-weight: 700;
                cursor: pointer;
                transition: transform 0.18s ease, box-shadow 0.18s ease, opacity 0.18s ease;
                letter-spacing: 0.4px;
                font-size: 0.95rem;
            }

            .confirm-btn:hover {
                transform: translateY(-1px);
            }

            .confirm-btn.ghost {
                background: #f3f4f6;
                color: #1e3a5f;
                box-shadow: inset 0 0 0 1px #d9dce2;
            }

            .confirm-btn.danger {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                box-shadow: 0 6px 16px rgba(231, 76, 60, 0.4);
            }

            #create-post-btn {
                background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%);
                color: #ffffff;
            }

            #create-post-btn:hover {
                background: linear-gradient(135deg, #e8b896 0%, #d4a574 100%);
            }

            #admin-login-btn {
                background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
                color: #ffffff;
            }

            #admin-login-btn:hover {
                background: linear-gradient(135deg, #5fa3f5 0%, #4a90e2 100%);
            }

            #logout-btn {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
            }

            #logout-btn:hover {
                background: linear-gradient(135deg, #ec7063 0%, #e74c3c 100%);
            }

            #login-btn {
                background: linear-gradient(135deg, #d4a574 0%, #b8956a 100%);
                color: #ffffff;
            }

            #login-btn:hover {
                background: linear-gradient(135deg, #e8b896 0%, #d4a574 100%);
            }

            #profile-btn {
                background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
                color: #ffffff;
            }

            #profile-btn:hover {
                background: linear-gradient(135deg, #52be80 0%, #27ae60 100%);
            }

            .posts-container {
                max-width: 900px;
                margin: 0 auto;
            }

            .loading {
                text-align: center;
                color: #ffffff;
                padding: 40px 20px;
                font-size: 1.1rem;
            }

            .spinner {
                display: inline-block;
                width: 40px;
                height: 40px;
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-top-color: #ffffff;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-bottom: 16px;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }

            .no-posts {
                text-align: center;
                padding: 60px 20px;
                color: #ffffff;
            }

            .no-posts-title {
                font-size: 1.5rem;
                margin-bottom: 12px;
                font-weight: 300;
                letter-spacing: 1px;
            }

            .no-posts-text {
                font-size: 1rem;
                color: #d4a574;
            }

            .post {
                background: #ffffff;
                border-radius: 8px;
                padding: 32px;
                margin-bottom: 24px;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
                transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
                opacity: 0;
                animation: slideUp 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
            }

            @keyframes slideUp {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .post:nth-child(1) { animation-delay: 0.1s; }
            .post:nth-child(2) { animation-delay: 0.2s; }
            .post:nth-child(3) { animation-delay: 0.3s; }
            .post:nth-child(n+4) { animation-delay: 0.4s; }

            .post:hover {
                transform: translateY(-4px);
                box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            }

            .post-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                margin-bottom: 16px;
            }

            .post h2 {
                color: #1e3a5f;
                font-size: 1.6rem;
                font-weight: 600;
                margin: 0;
                line-height: 1.3;
                flex: 1;
                letter-spacing: 0.3px;
            }

            .post-date {
                color: #95a5a6;
                font-size: 0.85rem;
                white-space: nowrap;
                margin-left: 16px;
                font-weight: 500;
            }

            .post-divider {
                height: 2px;
                background: linear-gradient(to right, #d4a574 0%, transparent 100%);
                margin: 16px 0;
            }

            .post p {
                color: #2c3e50;
                font-size: 1rem;
                line-height: 1.7;
                margin: 0;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }

            .post-excerpt {
                display: -webkit-box;
                -webkit-line-clamp: 3;
                line-clamp: 3;
                -webkit-box-orient: vertical;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .post-meta {
                margin-top: 16px;
                padding-top: 16px;
                border-top: 1px solid #ecf0f1;
                display: flex;
                justify-content: space-between;
                align-items: center;
                font-size: 0.9rem;
                color: #7f8c8d;
            }

            .admin-controls {
                display: flex;
                gap: 8px;
                align-items: center;
                margin-left: 12px;
            }

            .admin-btn {
                background: transparent;
                border: 1px solid rgba(0,0,0,0.06);
                padding: 6px 10px;
                border-radius: 6px;
                cursor: pointer;
                font-size: 0.9rem;
            }

            .admin-btn.edit {
                color: #2c3e50;
                border-color: #d4a574;
            }

            .admin-btn.delete {
                color: #fff;
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                border: none;
            }

            .post-word-count {
                color: #d4a574;
                font-weight: 500;
            }

            .reaction-useful-btn, .reaction-notuseful-btn {
                transition: all 0.2s ease;
                padding: 2px 6px;
                border-radius: 4px;
                user-select: none;
            }

            .reaction-useful-btn:hover {
                background: rgba(39, 174, 96, 0.2);
                transform: scale(1.1);
            }

            .reaction-notuseful-btn:hover {
                background: rgba(231, 76, 60, 0.2);
                transform: scale(1.1);
            }

            .reaction-useful-btn:disabled, .reaction-notuseful-btn:disabled {
                opacity: 0.7;
                cursor: not-allowed;
            }

            .reaction-chip {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                padding: 6px 12px;
                border-radius: 999px;
                background: #f4f6f8;
                box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                transition: all 0.2s ease;
            }

            .reaction-chip.useful {
                color: #27ae60;
                border: 1px solid rgba(39, 174, 96, 0.15);
            }

            .reaction-chip.notuseful {
                color: #e74c3c;
                border: 1px solid rgba(231, 76, 60, 0.15);
            }

            .reaction-chip:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.12);
            }

            .reaction-chip .reaction-count {
                font-weight: 700;
                color: inherit;
            }

            .avatar-chip {
                width: 34px;
                height: 34px;
                border-radius: 50%;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-weight: 700;
                color: #fff;
                box-shadow: 0 3px 8px rgba(0,0,0,0.12);
                text-transform: uppercase;
                flex-shrink: 0;
            }

            .error-message {
                background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
                color: #ffffff;
                padding: 20px;
                border-radius: 8px;
                margin: 20px auto;
                max-width: 900px;
                text-align: center;
                font-weight: 500;
            }

            @media (max-width: 768px) {
                h1 {
                    font-size: 2rem;
                }

                .controls {
                    flex-direction: column;
                    width: 100%;
                }

                button {
                    width: 100%;
                }

                .post {
                    padding: 20px;
                }

                .post h2 {
                    font-size: 1.3rem;
                }

                .post-header {
                    flex-direction: column;
                }

                .post-date {
                    margin-left: 0;
                    margin-top: 8px;
                }
            }

            /* Toast Notifications */
            .toast-container {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
            }

            .toast {
                background: #ffffff;
                padding: 16px 20px;
                border-radius: 8px;
                margin-bottom: 12px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
                display: flex;
                align-items: center;
                gap: 12px;
                animation: slideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
                min-height: 48px;
            }

            .toast.success {
                border-left: 4px solid #4CAF50;
            }

            .toast.error {
                border-left: 4px solid #f44336;
            }

            .toast.info {
                border-left: 4px solid #2196F3;
            }

            .toast.warning {
                border-left: 4px solid #ff9800;
            }

            .toast-icon {
                font-size: 1.2rem;
                flex-shrink: 0;
            }

            .toast-message {
                flex: 1;
                font-size: 0.95rem;
                color: #333;
                font-weight: 500;
            }

            .toast-close {
                cursor: pointer;
                font-size: 1.2rem;
                color: #999;
                flex-shrink: 0;
                transition: color 0.2s;
            }

            .toast-close:hover {
                color: #333;
            }

            @keyframes slideIn {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }

            @keyframes buttonPulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.08); }
                100% { transform: scale(1); }
            }

            .count-bump {
                animation: bump 0.35s ease;
            }

            @keyframes bump {
                0% { transform: translateY(0); }
                40% { transform: translateY(-4px); }
                100% { transform: translateY(0); }
            }

            /* Notifications UI */
            .notif-btn {
                position: relative;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                color: #ffffff;
                display: none;
            }

            .notif-badge {
                position: absolute;
                top: -8px;
                right: -8px;
                background: linear-gradient(135deg, #f83600 0%, #f9d423 100%);
                color: #fff;
                border-radius: 999px;
                padding: 2px 7px;
                font-size: 0.72rem;
                font-weight: 800;
                box-shadow: 0 6px 16px rgba(0,0,0,0.25);
                display: none;
            }

            .notification-panel {
                position: fixed;
                top: 110px;
                right: 20px;
                width: min(420px, calc(100% - 32px));
                background: rgba(255,255,255,0.97);
                backdrop-filter: blur(10px);
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.35);
                border: 1px solid rgba(255,255,255,0.5);
                padding: 14px;
                z-index: 11000;
                opacity: 0;
                transform: translateY(-8px) scale(0.98);
                pointer-events: none;
                transition: opacity 0.18s ease, transform 0.2s ease;
            }

            .notification-panel.show {
                opacity: 1;
                transform: translateY(0) scale(1);
                pointer-events: all;
            }

            .notification-header {
                display: flex;
                align-items: center;
                justify-content: space-between;
                gap: 10px;
                padding: 6px 6px 10px;
            }

            .notification-title {
                display: flex;
                align-items: center;
                gap: 10px;
                color: #1e3a5f;
                font-weight: 800;
                letter-spacing: 0.3px;
            }

            .notification-actions {
                display: flex;
                gap: 6px;
                align-items: center;
            }

            .notif-chip {
                border: none;
                background: #f3f4f6;
                color: #1e3a5f;
                border-radius: 10px;
                padding: 8px 12px;
                font-weight: 700;
                cursor: pointer;
                transition: transform 0.18s ease, box-shadow 0.18s ease;
            }

            .notif-chip:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }

            .notification-list {
                max-height: 420px;
                overflow-y: auto;
                padding: 4px;
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            .notif-item {
                display: grid;
                grid-template-columns: auto 1fr auto;
                gap: 12px;
                align-items: center;
                background: linear-gradient(135deg, rgba(212,165,116,0.08) 0%, rgba(30,58,95,0.06) 100%);
                border: 1px solid rgba(0,0,0,0.04);
                border-radius: 12px;
                padding: 12px 12px;
                transition: transform 0.16s ease, box-shadow 0.16s ease, background 0.2s ease;
                cursor: pointer;
            }

            .notif-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 10px 28px rgba(0,0,0,0.12);
            }

            .notif-item.unread {
                background: linear-gradient(135deg, rgba(24,118,210,0.08) 0%, rgba(104,159,56,0.08) 100%);
                border-color: rgba(104,159,56,0.16);
            }

            .notif-icon {
                width: 42px;
                height: 42px;
                border-radius: 12px;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 1.1rem;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                color: #fff;
                box-shadow: 0 6px 16px rgba(0,0,0,0.18);
            }

            .notif-body {
                display: flex;
                flex-direction: column;
                gap: 4px;
            }

            .notif-message {
                font-weight: 700;
                color: #1e3a5f;
                letter-spacing: 0.2px;
            }

            .notif-meta {
                font-size: 0.88rem;
                color: #6b7280;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .notif-pill {
                padding: 3px 9px;
                border-radius: 999px;
                font-weight: 700;
                font-size: 0.78rem;
                background: #ecf0f1;
                color: #1e3a5f;
            }

            .notif-delete {
                border: none;
                background: #f3f4f6;
                color: #c0392b;
                border-radius: 10px;
                padding: 8px 10px;
                cursor: pointer;
                transition: background 0.16s ease, transform 0.16s ease;
            }

            .notif-delete:hover {
                background: #fbeaea;
                transform: translateY(-1px);
            }

            .notif-empty {
                text-align: center;
                color: #6b7280;
                padding: 20px 10px;
            }

            @media (max-width: 600px) {
                .notification-panel {
                    right: 10px;
                    left: 10px;
                    top: 90px;
                    width: auto;
                }
            }

            @media (max-width: 600px) {
                .toast-container {
                    right: 10px;
                    left: 10px;
                    max-width: none;
                }

                .toast {
                    padding: 14px 16px;
                }
            }

            /* ========== PAGE TRANSITIONS ========== */
            .page-transition-overlay {
                position: fixed;
                inset: 0;
                z-index: 99999;
                pointer-events: none;
                background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%);
                opacity: 0;
                transition: opacity 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .page-transition-overlay.active {
                opacity: 1;
                pointer-events: all;
            }

            .page-transition-overlay .transition-content {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                text-align: center;
                color: #ffffff;
            }

            .page-transition-overlay .transition-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(255, 255, 255, 0.2);
                border-top-color: #d4a574;
                border-radius: 50%;
                animation: transitionSpin 0.8s linear infinite;
                margin: 0 auto 16px;
            }

            .page-transition-overlay .transition-text {
                font-size: 1rem;
                font-weight: 500;
                letter-spacing: 1px;
                opacity: 0.9;
            }

            @keyframes transitionSpin {
                to { transform: rotate(360deg); }
            }

            /* Page enter animation */
            body {
                animation: pageEnter 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            }

            @keyframes pageEnter {
                from {
                    opacity: 0;
                    transform: translateY(12px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </head>
    <body>
        <!-- Page Transition Overlay -->
        <div class="page-transition-overlay" id="pageTransitionOverlay">
            <div class="transition-content">
                <div class="transition-spinner"></div>
                <div class="transition-text">Loading...</div>
            </div>
        </div>

        <div class="toast-container" id="toastContainer"></div>

        <div class="notification-panel" id="notificationPanel" aria-live="polite">
            <div class="notification-header">
                <div class="notification-title">âœ¨ Notifications</div>
                <div class="notification-actions">
                    <button class="notif-chip" id="notifRefresh" aria-label="Refresh notifications">â†» Refresh</button>
                    <button class="notif-chip" id="notifClose" aria-label="Close notifications">âœ– Close</button>
                </div>
            </div>
            <div id="notificationList" class="notification-list"></div>
            <div id="notificationEmpty" class="notif-empty" style="display:none;">No notifications yet. Engage with the community to see updates here.</div>
        </div>

        <div class="header">
            <h1>Blog Hub</h1>
            <p class="header-subtitle">Discover inspiring stories and insights</p>
        </div>

        <div class="controls" role="toolbar">
            <div class="search-toolbar" aria-label="Search and sort posts">
                <div class="sort-dropdown">
                    <button id="sort-btn" class="sort-btn" aria-haspopup="listbox" aria-expanded="false">
                        <span class="sort-icon">â‡…</span>
                        <span class="sort-label" id="sort-label">Sort: Latest</span>
                    </button>
                    <div id="sort-menu" class="sort-menu" role="listbox" aria-label="Sort posts">
                        <button class="sort-option active" data-sort="time_desc">ðŸ•’ Time: Latest</button>
                        <button class="sort-option" data-sort="useful_desc">ðŸ”¥ Popularity: Most useful</button>
                        <button class="sort-option" data-sort="notuseful_desc">ðŸ‘Ž Popularity: Least useful</button>
                    </div>
                </div>
                <div class="search-group">
                    <input id="search-input" class="search-input" type="search" placeholder="Search title, description, tags, or @author" aria-label="Search posts by title, description, tags, or author" />
                    <button id="search-btn" aria-label="Search">ðŸ”Ž Search</button>
                    <button id="clear-search-btn" style="display:none; background:#ecf0f1;" aria-label="Clear search">âœ–</button>
                </div>
            </div>
            <button id="notifications-btn" class="notif-btn" aria-label="Notifications" style="display:none;">
                ðŸ”” Notifications
                <span id="notifBadge" class="notif-badge">0</span>
            </button>
            <button id="create-post-btn" onclick="navigateWithTransition('create-post.html')" style="display: none;">
                âœŽ Create New Post
            </button>
            <button id="admin-login-btn" onclick="navigateWithTransition('login.html')" style="display: none;">
                ðŸ‘¤ Login
            </button>
            <button id="register-btn" onclick="navigateWithTransition('register.html')" style="display: none; background: linear-gradient(135deg, #8bc34a 0%, #689f38 100%); color: #ffffff;">
                âœ¨ Register
            </button>
            <button id="profile-btn" onclick="goToProfile()" style="display: none;">
                ðŸ‘¤ My Profile
            </button>
            <button id="logout-btn" onclick="handleLogout()" style="display: none;">
                ðŸšª Log Out
            </button>
        </div>

        <div class="posts-container">
            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Loading stories...</p>
            </div>
            <div id="search-info" style="max-width:900px;margin:0 auto 18px;color:#ffffff;display:none;text-align:center;font-size:0.95rem;"></div>
            <div id="posts-container"></div>
            <div id="error-container"></div>
        </div>

        <script>
            // Constants
            const LOADING_ELEMENT = document.getElementById('loading');
            const POSTS_CONTAINER = document.getElementById('posts-container');
            const ERROR_CONTAINER = document.getElementById('error-container');
            const CREATE_POST_BTN = document.getElementById('create-post-btn');
            const ADMIN_LOGIN_BTN = document.getElementById('admin-login-btn');
            const PROFILE_BTN = document.getElementById('profile-btn');
            const LOGOUT_BTN = document.getElementById('logout-btn');
            const SEARCH_INPUT = document.getElementById('search-input');
            const SEARCH_BTN = document.getElementById('search-btn');
            const CLEAR_SEARCH_BTN = document.getElementById('clear-search-btn');
            const SEARCH_INFO = document.getElementById('search-info');
            const SORT_BTN = document.getElementById('sort-btn');
            const SORT_MENU = document.getElementById('sort-menu');
            const SORT_LABEL = document.getElementById('sort-label');
            const REGISTER_BTN = document.getElementById('register-btn');
            const NOTIF_BTN = document.getElementById('notifications-btn');
            const NOTIF_BADGE = document.getElementById('notifBadge');
            const NOTIF_PANEL = document.getElementById('notificationPanel');
            const NOTIF_LIST = document.getElementById('notificationList');
            const NOTIF_EMPTY = document.getElementById('notificationEmpty');
            const NOTIF_REFRESH = document.getElementById('notifRefresh');
            const NOTIF_CLOSE = document.getElementById('notifClose');
            let CURRENT_USER = { isAdmin: false, userId: null };
            let NOTIFICATIONS = [];
            let notifPoll = null;
            let notifPanelOpen = false;
            let LAST_POSTS = [];
            let CURRENT_SORT = 'time_desc';

            const AVATAR_PALETTE = {
                aurora: 'linear-gradient(135deg, #5efce8 0%, #736efe 100%)',
                sunset: 'linear-gradient(135deg, #f83600 0%, #f9d423 100%)',
                wave: 'linear-gradient(135deg, #00c6ff 0%, #0072ff 100%)',
                forest: 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)',
                midnight: 'linear-gradient(135deg, #141e30 0%, #243b55 100%)',
                plum: 'linear-gradient(135deg, #cc2b5e 0%, #753a88 100%)',
                citrus: 'linear-gradient(135deg, #fceabb 0%, #f8b500 100%)',
                ember: 'linear-gradient(135deg, #e65c00 0%, #f9d423 100%)',
                mint: 'linear-gradient(135deg, #a8ff78 0%, #78ffd6 100%)',
            };

            function avatarStyle(key) {
                return AVATAR_PALETTE[key] || 'linear-gradient(135deg, #d4a574 0%, #b8956a 100%)';
            }

            let searchTimeout = null;

            // Toast notification system
            function showToast(message, type = 'info', duration = 3000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'âœ“',
                    error: 'âœ•',
                    info: 'â„¹',
                    warning: 'âš '
                };
                
                toast.innerHTML = `
                    <span class="toast-icon">${icons[type] || icons.info}</span>
                    <span class="toast-message">${message}</span>
                    <span class="toast-close">&times;</span>
                `;
                
                container.appendChild(toast);
                
                const closeBtn = toast.querySelector('.toast-close');
                closeBtn.addEventListener('click', () => {
                    toast.style.animation = 'slideIn 0.3s reverse cubic-bezier(0.34, 1.56, 0.64, 1)';
                    setTimeout(() => toast.remove(), 300);
                });
                
                if (duration > 0) {
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.style.animation = 'slideIn 0.3s reverse cubic-bezier(0.34, 1.56, 0.64, 1)';
                            setTimeout(() => toast.remove(), 300);
                        }
                    }, duration);
                }
                
                return toast;
            }

            function ensureConfirmDialog() {
                if (document.getElementById('confirmOverlay')) return;
                const overlay = document.createElement('div');
                overlay.id = 'confirmOverlay';
                overlay.className = 'confirm-overlay';
                overlay.innerHTML = `
                    <div class="confirm-card">
                        <div class="confirm-icon">ðŸ—‘</div>
                        <h3 id="confirmTitle">Confirm delete</h3>
                        <p id="confirmMessage">This action cannot be undone.</p>
                        <div class="confirm-actions">
                            <button class="confirm-btn ghost" id="confirmCancel">Cancel</button>
                            <button class="confirm-btn danger" id="confirmConfirm">Delete</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }

            function confirmAction(message, confirmLabel = 'Delete', title = 'Are you sure?') {
                ensureConfirmDialog();
                const overlay = document.getElementById('confirmOverlay');
                const messageEl = document.getElementById('confirmMessage');
                const titleEl = document.getElementById('confirmTitle');
                const confirmBtn = document.getElementById('confirmConfirm');
                const cancelBtn = document.getElementById('confirmCancel');

                messageEl.textContent = message;
                titleEl.textContent = title;
                confirmBtn.textContent = confirmLabel;

                overlay.style.display = 'flex';
                requestAnimationFrame(() => overlay.classList.add('show'));

                return new Promise((resolve) => {
                    const cleanup = (result) => {
                        overlay.classList.remove('show');
                        setTimeout(() => { overlay.style.display = 'none'; }, 220);
                        confirmBtn.onclick = null;
                        cancelBtn.onclick = null;
                        overlay.onclick = null;
                        resolve(result);
                    };

                    confirmBtn.onclick = (e) => { e.stopPropagation(); cleanup(true); };
                    cancelBtn.onclick = (e) => { e.stopPropagation(); cleanup(false); };
                    overlay.onclick = (e) => {
                        if (e.target === overlay) cleanup(false);
                    };
                });
            }

            function getQueryParam(name) {
                return new URLSearchParams(window.location.search).get(name);
            }

            function updateUrlQuery(q) {
                const url = new URL(window.location.href);
                if (q) url.searchParams.set('q', q);
                else url.searchParams.delete('q');
                history.replaceState(null, '', url.toString());
            }

            async function doSearch(q) {
                q = (q || '').toString().trim();
                if (!q) {
                    SEARCH_INFO.style.display = 'none';
                    CLEAR_SEARCH_BTN.style.display = 'none';
                    updateUrlQuery('');
                    const posts = await fetchPosts();
                    LAST_POSTS = Array.isArray(posts) ? posts : [];
                    renderSortedPosts(LAST_POSTS);
                    return;
                }

                SEARCH_INFO.style.display = 'block';
                SEARCH_INFO.textContent = `Searching for "${q}"...`;
                LOADING_ELEMENT.style.display = 'block';
                try {
                    const resp = await fetch(`/api/search?q=${encodeURIComponent(q)}`);
                    if (!resp.ok) throw new Error('Search failed');
                    const rows = await resp.json();
                    if (rows.length === 0) {
                        SEARCH_INFO.textContent = `No results for "${q}"`;
                    } else {
                        SEARCH_INFO.textContent = `Showing ${rows.length} result${rows.length===1?'':'s'} for "${q}"`;
                    }
                    CLEAR_SEARCH_BTN.style.display = 'inline-block';
                    LAST_POSTS = Array.isArray(rows) ? rows : [];
                    renderSortedPosts(LAST_POSTS);
                    updateUrlQuery(q);
                } catch (err) {
                    console.error('Search error', err);
                    showError('Search failed. Try again.');
                } finally {
                    LOADING_ELEMENT.style.display = 'none';
                }
            }

            function sortValueNumber(value) {
                const n = Number(value);
                return Number.isFinite(n) ? n : 0;
            }

            function applySort(posts) {
                const items = Array.isArray(posts) ? [...posts] : [];
                if (CURRENT_SORT === 'time_desc') {
                    return items.sort((a, b) => {
                        const aTime = a.created_at ? new Date(a.created_at).getTime() : 0;
                        const bTime = b.created_at ? new Date(b.created_at).getTime() : 0;
                        if (bTime !== aTime) return bTime - aTime;
                        return sortValueNumber(b.id) - sortValueNumber(a.id);
                    });
                }
                if (CURRENT_SORT === 'useful_desc') {
                    return items.sort((a, b) => {
                        const aVal = sortValueNumber(a.useful_count ?? a.useful);
                        const bVal = sortValueNumber(b.useful_count ?? b.useful);
                        if (bVal !== aVal) return bVal - aVal;
                        return sortValueNumber(b.id) - sortValueNumber(a.id);
                    });
                }
                if (CURRENT_SORT === 'notuseful_desc') {
                    return items.sort((a, b) => {
                        const aVal = sortValueNumber(a.notuseful_count ?? a.notUseful);
                        const bVal = sortValueNumber(b.notuseful_count ?? b.notUseful);
                        if (bVal !== aVal) return bVal - aVal;
                        return sortValueNumber(b.id) - sortValueNumber(a.id);
                    });
                }
                return items;
            }

            function renderSortedPosts(posts) {
                const sorted = applySort(posts);
                renderPosts(sorted);
            }

            function setSort(sortKey) {
                CURRENT_SORT = sortKey;
                if (SORT_MENU) {
                    SORT_MENU.querySelectorAll('.sort-option').forEach((option) => {
                        option.classList.toggle('active', option.dataset.sort === sortKey);
                    });
                }
                if (SORT_LABEL) {
                    const labels = {
                        time_desc: 'Sort: Latest',
                        useful_desc: 'Sort: Most useful',
                        notuseful_desc: 'Sort: Least useful'
                    };
                    SORT_LABEL.textContent = labels[sortKey] || 'Sort';
                }
                renderSortedPosts(LAST_POSTS);
            }

            function closeSortMenu() {
                if (!SORT_MENU || !SORT_BTN) return;
                SORT_MENU.classList.remove('show');
                SORT_BTN.setAttribute('aria-expanded', 'false');
            }

            function toggleSortMenu() {
                if (!SORT_MENU || !SORT_BTN) return;
                const open = SORT_MENU.classList.toggle('show');
                SORT_BTN.setAttribute('aria-expanded', open ? 'true' : 'false');
            }

            // Wire up search interactions
            if (SEARCH_INPUT) {
                SEARCH_INPUT.addEventListener('input', (e) => {
                    const v = e.target.value;
                    if (searchTimeout) clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => doSearch(v), 350);
                });
            }

            if (SEARCH_BTN) SEARCH_BTN.addEventListener('click', () => doSearch(SEARCH_INPUT.value));
            if (CLEAR_SEARCH_BTN) CLEAR_SEARCH_BTN.addEventListener('click', () => {
                SEARCH_INPUT.value = '';
                CLEAR_SEARCH_BTN.style.display = 'none';
                doSearch('');
            });

            if (SORT_BTN) {
                SORT_BTN.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleSortMenu();
                });
            }

            if (SORT_MENU) {
                SORT_MENU.addEventListener('click', (e) => {
                    const option = e.target.closest('.sort-option');
                    if (!option) return;
                    setSort(option.dataset.sort);
                    closeSortMenu();
                });
            }

            document.addEventListener('click', (e) => {
                if (!SORT_MENU || !SORT_BTN) return;
                if (!e.target.closest('.sort-dropdown')) closeSortMenu();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeSortMenu();
            });

            // Fetch current user
            async function fetchCurrentUser() {
                try {
                    const response = await fetch('/api/auth/me');
                    if (response.ok) {
                        const data = await response.json();
                        return { isAdmin: data.isAdmin === true, userId: data.id || data.userId || null, username: data.username };
                    }
                    return { isAdmin: false, userId: null };
                } catch (error) {
                    console.error('Error fetching user:', error);
                    return { isAdmin: false, userId: null };
                }
            }

            // Fetch posts from API
            async function fetchPosts() {
                try {
                    LOADING_ELEMENT.style.display = 'block';
                    const response = await fetch('/api/posts');
                    
                    if (response.ok) {
                        return await response.json();
                    }
                    throw new Error('Failed to fetch posts');
                } catch (error) {
                    console.error('Error fetching posts:', error);
                    showError('Unable to load posts. Please try again later.');
                    return [];
                } finally {
                    LOADING_ELEMENT.style.display = 'none';
                }
            }

            // Format date nicely
            function formatDate(dateString) {
                const date = new Date(dateString);
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString('en-US', options);
            }

            function timeAgo(dateString) {
                const now = new Date();
                const then = new Date(dateString);
                const diff = Math.max(0, now - then);
                const mins = Math.floor(diff / 60000);
                if (mins < 1) return 'Just now';
                if (mins < 60) return `${mins}m ago`;
                const hours = Math.floor(mins / 60);
                if (hours < 24) return `${hours}h ago`;
                const days = Math.floor(hours / 24);
                if (days < 7) return `${days}d ago`;
                return formatDate(dateString);
            }

            // Count words in text
            function countWords(text) {
                return text.trim().split(/\s+/).length;
            }

            // Truncate text
            function truncateText(text, limit = 150) {
                if (text.length <= limit) return text;
                return text.substring(0, limit).trim() + '...';
            }

            // Show error message
            function showError(message) {
                ERROR_CONTAINER.innerHTML = `<div class="error-message">${message}</div>`;
            }

            // Render posts
            function renderPosts(posts) {
                POSTS_CONTAINER.innerHTML = '';

                if (posts.length === 0) {
                    POSTS_CONTAINER.innerHTML = `
                        <div class="no-posts">
                            <p class="no-posts-title">No Stories Yet</p>
                            <p class="no-posts-text">Check back soon for inspiring content!</p>
                        </div>
                    `;
                    return;
                }

                posts.forEach(post => {
                    const wordCount = countWords(post.body);
                    const excerpt = truncateText(post.body, 200);
                    const date = post.created_at ? formatDate(post.created_at) : '';
                    const postUrl = `/post.html?id=${post.id}`;
                    const authorDisplay = post.author_name || 'Unknown';
                    const isAdminPost = post.is_admin_post === 1 || post.author_id === null;
                    const authorInitial = (authorDisplay || 'U').toString().charAt(0).toUpperCase();
                    const avatarBg = avatarStyle(post.author_avatar || '');

                    // Determine if current user can edit/delete this post
                    let canEdit = false;
                    let canDelete = false;
                    let canFlag = false;

                    if (CURRENT_USER.isAdmin) {
                      canEdit = post.author_id === null; // Admin can only edit own posts
                      canDelete = true; // Admin can delete any post
                      canFlag = true; // Admin can flag any post
                    } else if (CURRENT_USER.userId) {
                      canEdit = post.author_id === CURRENT_USER.userId; // User can only edit own
                      canDelete = post.author_id === CURRENT_USER.userId; // User can only delete own
                    }

                    const postElement = document.createElement('article');
                    postElement.className = 'post';
                    postElement.style.cursor = 'pointer';
                    if (post.is_flagged) {
                      postElement.style.borderLeft = '5px solid #e74c3c';
                    }
                    postElement.innerHTML = `
                        <div class="post-header">
                            <h2>${escapeHtml(post.title)}${post.is_flagged ? ' ðŸš© FLAGGED' : ''}</h2>
                            ${date ? `<span class="post-date">${date}</span>` : ''}
                        </div>
                        <div class="post-divider"></div>
                        <p class="post-excerpt">${escapeHtml(excerpt)}</p>
                        <div class="post-meta">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <span class="post-word-count">${wordCount} words</span>
                                ${isAdminPost ? `
                                    <span style="display:flex; align-items:center; gap:8px; color:#1e3a5f; font-weight:700;">
                                        <span class="avatar-chip" style="background:linear-gradient(135deg, #1e3a5f 0%, #2d5a8c 100%)">ðŸ‘‘</span>
                                        Admin
                                    </span>
                                ` : `
                                    <span style="display:flex; align-items:center; gap:8px; color:#d4a574; font-weight:600;">
                                        <span class="avatar-chip" style="background:${avatarBg}">${escapeHtml(authorInitial)}</span>
                                        ${escapeHtml(authorDisplay)}
                                    </span>
                                `}
                                <span style="color:#d4a574;">ðŸ’¬ ${post.comment_count || 0}</span>
                                <span class="reaction-chip useful reaction-useful-btn" data-id="${post.id}">ðŸ‘ <span class="reaction-count">${post.useful_count || 0}</span></span>
                                <span class="reaction-chip notuseful reaction-notuseful-btn" data-id="${post.id}">ðŸ‘Ž <span class="reaction-count">${post.notuseful_count || 0}</span></span>
                                <span>â†’ Read More</span>
                            </div>
                            ${canEdit || canDelete || canFlag ? `<div class="admin-controls">
                                ${canEdit ? `<button class="admin-btn edit" data-id="${post.id}">âœŽ Edit</button>` : ''}
                                ${canDelete ? `<button class="admin-btn delete" data-id="${post.id}">ðŸ—‘ Delete</button>` : ''}
                                ${canFlag ? `<button class="admin-btn flag" data-id="${post.id}" data-flagged="${post.is_flagged ? 1 : 0}">${post.is_flagged ? 'âœ“ Unflag' : 'ðŸš© Flag'}</button>` : ''}
                            </div>` : ''}
                        </div>
                    `;

                    // Click anywhere on post to view
                    postElement.addEventListener('click', (e) => {
                        // if clicked an admin button, don't navigate
                        if (e.target.closest('.admin-btn')) return;
                        navigateWithTransition(postUrl);
                    });

                    // Attach button actions if visible
                    // Edit button
                    const editBtn = postElement.querySelector('.admin-btn.edit');
                    if (editBtn) {
                        editBtn.addEventListener('click', (ev) => {
                            ev.stopPropagation();
                            const id = ev.currentTarget.getAttribute('data-id');
                            navigateWithTransition(`/create-post.html?id=${id}&edit=1`);
                        });
                    }

                    // Delete button
                    const deleteBtn = postElement.querySelector('.admin-btn.delete');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            const id = ev.currentTarget.getAttribute('data-id');
                            const confirmed = await confirmAction('Delete this post? This action cannot be undone.', 'Delete post', 'Delete post?');
                            if (!confirmed) return;
                            try {
                                const resp = await fetch(`/api/posts/${id}`, { method: 'DELETE' });
                                if (resp.ok) {
                                    postElement.style.transition = 'opacity 0.3s, transform 0.3s';
                                    postElement.style.opacity = 0;
                                    postElement.style.transform = 'translateY(10px)';
                                    setTimeout(() => postElement.remove(), 300);
                                } else {
                                    const err = await resp.json();
                                    showError(err.error || 'Failed to delete post');
                                }
                            } catch (error) {
                                console.error('Delete failed', error);
                                showError('Delete failed. Try again.');
                            }
                        });
                    }

                    // Flag button
                    const flagBtn = postElement.querySelector('.admin-btn.flag');
                    if (flagBtn) {
                        flagBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            const id = ev.currentTarget.getAttribute('data-id');
                            const currentFlagged = parseInt(ev.currentTarget.getAttribute('data-flagged'));
                            const newFlagged = currentFlagged === 1 ? false : true;
                            try {
                                const resp = await fetch(`/api/posts/${id}/flag`, {
                                    method: 'PATCH',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ flag: newFlagged })
                                });
                                if (resp.ok) {
                                    // Update button and post styling
                                    ev.currentTarget.textContent = newFlagged ? 'âœ“ Unflag' : 'ðŸš© Flag';
                                    ev.currentTarget.setAttribute('data-flagged', newFlagged ? 1 : 0);
                                    const titleElem = postElement.querySelector('h2');
                                    if (newFlagged) {
                                        postElement.style.borderLeft = '5px solid #e74c3c';
                                        titleElem.textContent += ' ðŸš© FLAGGED';
                                    } else {
                                        postElement.style.borderLeft = '';
                                        titleElem.textContent = titleElem.textContent.replace(' ðŸš© FLAGGED', '');
                                    }
                                } else {
                                    const err = await resp.json();
                                    showError(err.error || 'Failed to flag post');
                                }
                            } catch (error) {
                                console.error('Flag failed', error);
                                showError('Flag failed. Try again.');
                            }
                        });
                    }

                    // Reaction buttons (useful/notuseful)
                    const usefulBtn = postElement.querySelector('.reaction-useful-btn');
                    const notusefulBtn = postElement.querySelector('.reaction-notuseful-btn');

                    if (usefulBtn) {
                        usefulBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            // Check if user is authenticated (user OR admin)
                            if (!CURRENT_USER.userId && !CURRENT_USER.isAdmin) {
                                navigateWithTransition('/login.html');
                                return;
                            }
                            const id = ev.currentTarget.getAttribute('data-id');
                            
                            ev.currentTarget.disabled = true;
                            const originalText = ev.currentTarget.textContent;
                            const btnClass = ev.currentTarget;
                            
                            try {
                                const resp = await fetch(`/api/posts/${id}/reactions`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ reaction_type: 'useful' })
                                });
                                if (resp.ok) {
                                    const data = await resp.json();
                                    const uCount = usefulBtn.querySelector('.reaction-count');
                                    const nCount = notusefulBtn.querySelector('.reaction-count');
                                    if (uCount && nCount) {
                                        uCount.textContent = data.useful;
                                        nCount.textContent = data.notUseful;
                                        uCount.classList.remove('count-bump');
                                        nCount.classList.remove('count-bump');
                                        void uCount.offsetWidth;
                                        uCount.classList.add('count-bump');
                                        nCount.classList.add('count-bump');
                                    }
                                    
                                    // Add visual feedback
                                    btnClass.style.animation = 'buttonPulse 0.3s ease';
                                    showToast('âœ“ Reaction updated!', 'success', 1500);
                                } else if (resp.status === 400) {
                                    showToast('Already voted this way', 'info', 1500);
                                }
                            } catch (error) {
                                console.error('Reaction failed', error);
                                showError('Reaction failed. Try again.');
                            } finally {
                                ev.currentTarget.disabled = false;
                            }
                        });
                    }

                    if (notusefulBtn) {
                        notusefulBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            // Check if user is authenticated (user OR admin)
                            if (!CURRENT_USER.userId && !CURRENT_USER.isAdmin) {
                                navigateWithTransition('/login.html');
                                return;
                            }
                            const id = ev.currentTarget.getAttribute('data-id');
                            
                            ev.currentTarget.disabled = true;
                            const originalText = ev.currentTarget.textContent;
                            const btnClass = ev.currentTarget;
                            
                            try {
                                const resp = await fetch(`/api/posts/${id}/reactions`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ reaction_type: 'notuseful' })
                                });
                                if (resp.ok) {
                                    const data = await resp.json();
                                    const uCount = usefulBtn.querySelector('.reaction-count');
                                    const nCount = notusefulBtn.querySelector('.reaction-count');
                                    if (uCount && nCount) {
                                        uCount.textContent = data.useful;
                                        nCount.textContent = data.notUseful;
                                        uCount.classList.remove('count-bump');
                                        nCount.classList.remove('count-bump');
                                        void uCount.offsetWidth;
                                        uCount.classList.add('count-bump');
                                        nCount.classList.add('count-bump');
                                    }
                                    
                                    // Add visual feedback
                                    btnClass.style.animation = 'buttonPulse 0.3s ease';
                                    showToast('âœ“ Reaction updated!', 'success', 1500);
                                } else if (resp.status === 400) {
                                    showToast('Already voted this way', 'info', 1500);
                                }
                            } catch (error) {
                                console.error('Reaction failed', error);
                                showError('Reaction failed. Try again.');
                            } finally {
                                ev.currentTarget.disabled = false;
                            }
                        });
                    }

                    POSTS_CONTAINER.appendChild(postElement);
                });
            }

            // Escape HTML to prevent XSS
            function escapeHtml(text) {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text.replace(/[&<>"']/g, m => map[m]);
            }

            function notificationsAllowed() {
                return CURRENT_USER && CURRENT_USER.userId && !CURRENT_USER.isAdmin;
            }

            function stopNotificationPolling() {
                if (notifPoll) {
                    clearInterval(notifPoll);
                    notifPoll = null;
                }
            }

            function startNotificationPolling() {
                stopNotificationPolling();
                notifPoll = setInterval(() => fetchNotifications(true), 20000);
            }

            function updateNotificationBadge() {
                if (!NOTIF_BADGE) return;
                const unread = NOTIFICATIONS.filter(n => !n.is_read).length;
                if (unread > 0) {
                    NOTIF_BADGE.style.display = 'inline-block';
                    NOTIF_BADGE.textContent = unread > 99 ? '99+' : unread;
                } else {
                    NOTIF_BADGE.style.display = 'none';
                }
            }

            function renderNotifications() {
                if (!NOTIF_LIST) return;
                NOTIF_LIST.innerHTML = '';

                if (!NOTIFICATIONS.length) {
                    if (NOTIF_EMPTY) NOTIF_EMPTY.style.display = 'block';
                    updateNotificationBadge();
                    return;
                }
                if (NOTIF_EMPTY) NOTIF_EMPTY.style.display = 'none';

                const typeIcons = {
                    flagged: 'ðŸš©',
                    flag_removed: 'âœ…',
                    reaction: 'ðŸ‘',
                    comment: 'ðŸ’¬'
                };

                const typePills = {
                    flagged: 'Flagged',
                    flag_removed: 'Flag removed',
                    reaction: 'Reaction',
                    comment: 'Comment'
                };

                NOTIFICATIONS.forEach((n) => {
                    const item = document.createElement('div');
                    item.className = `notif-item ${n.is_read ? 'read' : 'unread'}`;
                    const icon = typeIcons[n.type] || 'âœ¨';
                    const pill = typePills[n.type] || 'Update';
                    item.innerHTML = `
                        <div class="notif-icon">${icon}</div>
                        <div class="notif-body">
                            <div class="notif-message">${escapeHtml(n.message || 'You have a new update')}</div>
                            <div class="notif-meta">
                                <span class="notif-pill">${pill}</span>
                                <span>${timeAgo(n.created_at)}</span>
                            </div>
                        </div>
                        <button class="notif-delete" aria-label="Delete notification">ðŸ—‘</button>
                    `;

                    item.addEventListener('click', async () => {
                        if (!n.post_id) return;
                        await markNotificationRead(n.id);
                        window.location.href = `/post.html?id=${n.post_id}`;
                    });

                    const delBtn = item.querySelector('.notif-delete');
                    if (delBtn) {
                        delBtn.addEventListener('click', async (ev) => {
                            ev.stopPropagation();
                            await deleteNotification(n.id);
                        });
                    }

                    NOTIF_LIST.appendChild(item);
                });

                updateNotificationBadge();
            }

            async function fetchNotifications(isBackground = false) {
                if (!notificationsAllowed()) {
                    NOTIFICATIONS = [];
                    renderNotifications();
                    return;
                }
                try {
                    const resp = await fetch('/api/notifications');
                    if (!resp.ok) throw new Error('Failed to load notifications');
                    const data = await resp.json();
                    NOTIFICATIONS = Array.isArray(data) ? data : [];
                    renderNotifications();
                    if (!isBackground && !notifPanelOpen && NOTIFICATIONS.some(n => !n.is_read)) {
                        NOTIF_BADGE.classList.add('count-bump');
                        setTimeout(() => NOTIF_BADGE.classList.remove('count-bump'), 350);
                    }
                } catch (err) {
                    console.error('Notifications error', err);
                    if (!isBackground) showToast('Could not load notifications', 'error');
                }
            }

            async function markNotificationRead(id) {
                const target = NOTIFICATIONS.find(n => n.id === id);
                if (target && target.is_read) return true;
                try {
                    const resp = await fetch(`/api/notifications/${id}/read`, { method: 'PATCH' });
                    if (resp.ok) {
                        if (target) target.is_read = 1;
                        updateNotificationBadge();
                        return true;
                    }
                } catch (err) {
                    console.error('Mark read failed', err);
                }
                return false;
            }

            async function deleteNotification(id) {
                try {
                    const resp = await fetch(`/api/notifications/${id}`, { method: 'DELETE' });
                    if (resp.ok) {
                        NOTIFICATIONS = NOTIFICATIONS.filter(n => n.id !== id);
                        renderNotifications();
                        return true;
                    }
                } catch (err) {
                    console.error('Delete notification failed', err);
                }
                showToast('Could not delete notification', 'error');
                return false;
            }

            function toggleNotificationPanel(force) {
                if (!notificationsAllowed() || !NOTIF_PANEL) return;
                const nextState = force !== undefined ? force : !notifPanelOpen;
                notifPanelOpen = nextState;
                NOTIF_PANEL.classList.toggle('show', nextState);
                if (nextState) {
                    fetchNotifications(true);
                }
            }

            function setNotificationAccess(user) {
                if (!NOTIF_BTN) return;
                if (user && user.userId && !user.isAdmin) {
                    NOTIF_BTN.style.display = 'inline-block';
                    startNotificationPolling();
                    fetchNotifications(true);
                } else {
                    NOTIF_BTN.style.display = 'none';
                    toggleNotificationPanel(false);
                    NOTIFICATIONS = [];
                    renderNotifications();
                    stopNotificationPolling();
                }
            }

            if (NOTIF_BTN) NOTIF_BTN.addEventListener('click', () => toggleNotificationPanel());
            if (NOTIF_REFRESH) NOTIF_REFRESH.addEventListener('click', () => fetchNotifications());
            if (NOTIF_CLOSE) NOTIF_CLOSE.addEventListener('click', () => toggleNotificationPanel(false));
            document.addEventListener('click', (e) => {
                if (!notifPanelOpen) return;
                const withinPanel = NOTIF_PANEL && NOTIF_PANEL.contains(e.target);
                const withinBtn = NOTIF_BTN && NOTIF_BTN.contains(e.target);
                if (!withinPanel && !withinBtn) toggleNotificationPanel(false);
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && notifPanelOpen) toggleNotificationPanel(false);
            });

            // Update auth buttons display
            function updateAuthButtons(user) {
                if (user.isAdmin) {
                    CREATE_POST_BTN.style.display = 'inline-block';
                    ADMIN_LOGIN_BTN.style.display = 'none';
                    REGISTER_BTN.style.display = 'none';
                    PROFILE_BTN.style.display = 'inline-block';
                    LOGOUT_BTN.style.display = 'inline-block';
                } else if (user.userId) {
                    // Regular user logged in
                    CREATE_POST_BTN.style.display = 'inline-block';
                    ADMIN_LOGIN_BTN.style.display = 'none';
                    REGISTER_BTN.style.display = 'none';
                    PROFILE_BTN.style.display = 'inline-block';
                    LOGOUT_BTN.style.display = 'inline-block';
                } else {
                    // Not logged in
                    CREATE_POST_BTN.style.display = 'none';
                    ADMIN_LOGIN_BTN.style.display = 'inline-block';
                    REGISTER_BTN.style.display = 'inline-block';
                    PROFILE_BTN.style.display = 'none';
                    LOGOUT_BTN.style.display = 'none';
                }
            }

            // Handle logout
            async function handleLogout() {
                try {
                    const response = await fetch('/api/auth/logout', {
                        method: 'POST'
                    });
                    if (response.ok) {
                        showToast('Logged out successfully!', 'success', 1500);
                        updateAuthButtons({ isAdmin: false, userId: null });
                        setNotificationAccess({ userId: null, isAdmin: false });
                        setTimeout(() => window.location.reload(), 500);
                    }
                } catch (error) {
                    console.error('Logout error:', error);
                    showToast('Logout failed. Please try again.', 'error');
                }
            }

            // Go to profile with admin check
            function goToProfile() {
                if (CURRENT_USER.isAdmin) {
                    navigateWithTransition('/admin-profile.html');
                } else {
                    navigateWithTransition('/profile.html');
                }
            }

            // Initialize page
            async function initializePage() {
                try {
                    const user = await fetchCurrentUser();
                    CURRENT_USER = user || { isAdmin: false, userId: null };
                    updateAuthButtons(CURRENT_USER);
                    setNotificationAccess(CURRENT_USER);

                    const q = getQueryParam('q');
                    if (q) {
                        if (SEARCH_INPUT) SEARCH_INPUT.value = q;
                        await doSearch(q);
                    } else {
                        const posts = await fetchPosts();
                        LAST_POSTS = Array.isArray(posts) ? posts : [];
                        renderSortedPosts(LAST_POSTS);
                    }
                } catch (error) {
                    console.error('Error initializing page:', error);
                    showError('An error occurred. Please refresh the page.');
                }
            }

            // Load page when DOM is ready
            window.addEventListener('load', initializePage);

            // ========== SMOOTH PAGE TRANSITIONS ==========
            const PAGE_TRANSITION_OVERLAY = document.getElementById('pageTransitionOverlay');

            function navigateWithTransition(url) {
                if (!PAGE_TRANSITION_OVERLAY) {
                    window.location.href = url;
                    return;
                }
                PAGE_TRANSITION_OVERLAY.classList.add('active');
                setTimeout(() => {
                    window.location.href = url;
                }, 280);
            }

            // Intercept internal link clicks for smooth transitions
            document.addEventListener('click', (e) => {
                const link = e.target.closest('a[href]');
                if (!link) return;

                const href = link.getAttribute('href');
                if (!href) return;

                // Skip external links, anchors, javascript:, mailto:, tel:
                if (href.startsWith('http') || href.startsWith('#') || href.startsWith('javascript:') || href.startsWith('mailto:') || href.startsWith('tel:')) return;

                // Skip links with target="_blank"
                if (link.target === '_blank') return;

                e.preventDefault();
                navigateWithTransition(href);
            });

            // Handle browser back/forward with transition
            window.addEventListener('pageshow', (e) => {
                if (e.persisted && PAGE_TRANSITION_OVERLAY) {
                    PAGE_TRANSITION_OVERLAY.classList.remove('active');
                }
            });

            // Expose for programmatic navigation
            window.navigateWithTransition = navigateWithTransition;
        </script>
    </body>
</html>